---
interface Props {
  user?: {
    id: string;
    email: string;
    firstName: string;
    lastName: string;
    role: string;
    isActive: boolean;
  };
  isEdit?: boolean;
}

const { user, isEdit = false } = Astro.props;
---

<form id="user-form" class="space-y-6">
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- First Name -->
      <div>
        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
          First Name
        </label>
        <input
          type="text"
          id="firstName"
          name="firstName"
          value={user?.firstName}
          required
          class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
          placeholder="John"
        />
      </div>

      <!-- Last Name -->
      <div>
        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
          Last Name
        </label>
        <input
          type="text"
          id="lastName"
          name="lastName"
          value={user?.lastName}
          required
          class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
          placeholder="Doe"
        />
      </div>

      <!-- Email -->
      <div class="col-span-1 md:col-span-2">
        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
          Email Address
        </label>
        <input
          type="email"
          id="email"
          name="email"
          value={user?.email}
          required
          class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
          placeholder="john.doe@example.com"
        />
      </div>

      <!-- Role -->
      <div>
        <label for="role" class="block text-sm font-medium text-gray-700 mb-1"> Role </label>
        <select
          id="role"
          name="role"
          class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
        >
          <option value="EDITOR" selected={user?.role === 'EDITOR'}>Editor</option>
          <option value="ADMIN" selected={user?.role === 'ADMIN'}>Admin</option>
        </select>
        <p class="mt-1 text-xs text-gray-500">Admins have full access, Editors cannot manage users (UI restriction only for now).</p>
      </div>

      <!-- Status -->
      <div class="flex items-center pt-6">
        <label class="flex items-center cursor-pointer">
          <input
            type="checkbox"
            name="isActive"
            class="sr-only peer"
            checked={user ? user.isActive : true}
          />
          <div
            class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"
          >
          </div>
          <span class="ms-3 text-sm font-medium text-gray-700">Active Account</span>
        </label>
      </div>

      <!-- Password -->
      <div class="col-span-1 md:col-span-2 pt-4 border-t mt-4">
        <h3 class="text-sm font-medium text-gray-900 mb-4">
          {isEdit ? 'Change Password (Optional)' : 'Set Password'}
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required={!isEdit}
              minlength="8"
              class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
            />
          </div>
          <div>
            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">
              Confirm Password
            </label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              required={!isEdit}
              minlength="8"
              class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex items-center justify-end space-x-3">
    <a
      href="/admin/users"
      class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
    >
      Cancel
    </a>
    <button
      type="submit"
      id="submitBtn"
      class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
    >
      {isEdit ? 'Save Changes' : 'Create User'}
    </button>
  </div>
</form>

<script define:vars={{ isEdit, userId: user?.id }}>
  const form = document.getElementById('user-form');
  const submitBtn = document.getElementById('submitBtn');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Checkbox handling
    data.isActive = formData.get('isActive') === 'on';

    // Password validation
    if (data.password !== data.confirmPassword) {
      alert('Passwords do not match');
      return;
    }

    if (!data.password && !isEdit) {
      alert('Password is required');
      return;
    }

    // Remove empty password if edit
    if (isEdit && !data.password) {
      delete data.password;
    }
    delete data.confirmPassword;

    try {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      const url = isEdit ? `/api/admin/users/${userId}/update` : '/api/admin/users/create';
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        window.location.href = '/admin/users';
      } else {
        const error = await response.json();
        alert(error.error || 'Failed to save user');
        submitBtn.disabled = false;
        submitBtn.textContent = isEdit ? 'Save Changes' : 'Create User';
      }
    } catch (error) {
      console.error('Error saving user:', error);
      alert('An error occurred');
      submitBtn.disabled = false;
      submitBtn.textContent = isEdit ? 'Save Changes' : 'Create User';
    }
  });
</script>
