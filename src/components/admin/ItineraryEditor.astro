---
interface ItineraryDay {
  day: number;
  title: string;
  description: string;
  distance?: string;
  elevationGain?: string;
  meals?: string;
}

interface Props {
  itinerary?: ItineraryDay[];
}

const { itinerary = [] } = Astro.props;
const uniqueId = `itinerary-editor-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="itinerary-editor-container">
  <label class="block text-sm font-medium text-gray-700 mb-2">
    Itinerary
    <span class="text-gray-500 font-normal">(Optional)</span>
  </label>

  <div class="space-y-4" id={`${uniqueId}-items`}>
    {
      itinerary.map((day, index) => (
        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50" data-itinerary-item>
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-medium text-gray-700">
              Day <span data-day-number>{index + 1}</span>
            </h4>
            <button type="button" class="text-red-600 hover:text-red-800 text-sm" data-remove-item>
              Remove
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-2 md:col-span-1">
              <label class="block text-xs font-medium text-gray-500 mb-1">Title</label>
              <input
                type="text"
                value={day.title}
                placeholder="e.g. Arrival in Kathmandu"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                data-field="title"
              />
            </div>

            <div class="col-span-2 md:col-span-1">
              <label class="block text-xs font-medium text-gray-500 mb-1">Meals</label>
              <input
                type="text"
                value={day.meals || ''}
                placeholder="e.g. Breakfast, Lunch, Dinner"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                data-field="meals"
              />
            </div>

            <div class="col-span-2">
              <label class="block text-xs font-medium text-gray-500 mb-1">Description</label>
              <textarea
                rows="3"
                placeholder="Describe the day's activities..."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                data-field="description"
              >
                {day.description}
              </textarea>
            </div>

            <div class="col-span-2 md:col-span-1">
              <label class="block text-xs font-medium text-gray-500 mb-1">
                Distance (Optional)
              </label>
              <input
                type="text"
                value={day.distance || ''}
                placeholder="e.g. 45 km"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                data-field="distance"
              />
            </div>

            <div class="col-span-2 md:col-span-1">
              <label class="block text-xs font-medium text-gray-500 mb-1">
                Elevation Gain (Optional)
              </label>
              <input
                type="text"
                value={day.elevationGain || ''}
                placeholder="e.g. 1200m"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                data-field="elevationGain"
              />
            </div>
          </div>
        </div>
      ))
    }
  </div>

  <button
    type="button"
    id={`${uniqueId}-add-btn`}
    class="mt-3 px-4 py-2 bg-emerald-100 text-emerald-700 hover:bg-emerald-200 rounded-lg transition inline-flex items-center space-x-2"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"
      ></path>
    </svg>
    <span>Add Day</span>
  </button>

  <!-- Hidden input for form submission -->
  <input type="hidden" name="itinerary-json" id={`${uniqueId}-json`} value="" />
</div>

<script define:vars={{ uniqueId }}>
  // Register serializer
  if (typeof window !== 'undefined') {
    if (!window.itineraryEditorSerializers) {
      window.itineraryEditorSerializers = {};
    }

    window.itineraryEditorSerializers['itinerary'] = function () {
      const container = document.getElementById(`${uniqueId}-items`);
      const items = container ? container.querySelectorAll('[data-itinerary-item]') : [];
      const values = [];

      items.forEach((item, index) => {
        const title = item.querySelector('[data-field="title"]').value.trim();
        const description = item.querySelector('[data-field="description"]').value.trim();
        const meals = item.querySelector('[data-field="meals"]').value.trim();
        const distance = item.querySelector('[data-field="distance"]').value.trim();
        const elevationGain = item.querySelector('[data-field="elevationGain"]').value.trim();

        if (title || description) {
          values.push({
            day: index + 1,
            title,
            description,
            meals: meals || undefined,
            distance: distance || undefined,
            elevationGain: elevationGain || undefined,
          });
        }
      });

      return values.length > 0 ? values : null;
    };
  }

  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById(`${uniqueId}-items`);
    const addBtn = document.getElementById(`${uniqueId}-add-btn`);

    if (!container || !addBtn) {
      return;
    }

    function updateDayNumbers() {
      const items = container.querySelectorAll('[data-itinerary-item]');
      items.forEach((item, index) => {
        const dayNumberSpan = item.querySelector('[data-day-number]');
        if (dayNumberSpan) {
          dayNumberSpan.textContent = index + 1;
        }
      });
    }

    // Add item functionality
    addBtn.addEventListener('click', () => {
      const newItem = document.createElement('div');
      newItem.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
      newItem.setAttribute('data-itinerary-item', '');

      // Calculate next day number
      const currentCount = container.querySelectorAll('[data-itinerary-item]').length;

      newItem.innerHTML = `
        <div class="flex justify-between items-center mb-3">
          <h4 class="font-medium text-gray-700">Day <span data-day-number>${currentCount + 1}</span></h4>
          <button
            type="button"
            class="text-red-600 hover:text-red-800 text-sm"
            data-remove-item
          >
            Remove
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="col-span-2 md:col-span-1">
            <label class="block text-xs font-medium text-gray-500 mb-1">Title</label>
            <input
              type="text"
              placeholder="e.g. Arrival in Kathmandu"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              data-field="title"
            />
          </div>
          
          <div class="col-span-2 md:col-span-1">
            <label class="block text-xs font-medium text-gray-500 mb-1">Meals</label>
            <input
              type="text"
              placeholder="e.g. Breakfast, Lunch, Dinner"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              data-field="meals"
            />
          </div>

          <div class="col-span-2">
            <label class="block text-xs font-medium text-gray-500 mb-1">Description</label>
            <textarea
              rows="3"
              placeholder="Describe the day's activities..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              data-field="description"
            ></textarea>
          </div>

          <div class="col-span-2 md:col-span-1">
            <label class="block text-xs font-medium text-gray-500 mb-1">Distance (Optional)</label>
            <input
              type="text"
              placeholder="e.g. 45 km"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              data-field="distance"
            />
          </div>

          <div class="col-span-2 md:col-span-1">
            <label class="block text-xs font-medium text-gray-500 mb-1">Elevation Gain (Optional)</label>
            <input
              type="text"
              placeholder="e.g. 1200m"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              data-field="elevationGain"
            />
          </div>
        </div>
      `;

      // Attach remove event to new button
      const removeBtn = newItem.querySelector('[data-remove-item]');
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          newItem.remove();
          updateDayNumbers();
        });
      }

      container.appendChild(newItem);
    });

    // Remove item functionality for existing items
    container.querySelectorAll('[data-remove-item]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const target = e.target;
        const item = target.closest('[data-itinerary-item]');
        if (item) {
          item.remove();
          updateDayNumbers();
        }
      });
    });
  });
</script>
