---
export interface Props {
  images: Array<{
    url: string;
    alt?: string;
    caption?: string;
  }>;
  title?: string;
  className?: string;
}

const { images, title, className = '' } = Astro.props;

// Ensure we have at least one image
const galleryImages = (images && Array.isArray(images) && images.length > 0) ? images : [
  { url: '/images/package-placeholder.jpg', alt: 'Package Image' }
];

const mainImage = galleryImages[0];
const thumbnailImages = galleryImages.slice(1);
---

<div class={`package-gallery ${className}`}>
  {title && (
    <h3 class="text-lg font-semibold text-gray-900 mb-4">{title}</h3>
  )}
  
  <div class="grid grid-cols-1 gap-4">
    <!-- Main Image -->
    <div class="relative">
      <img 
        src={mainImage.url} 
        alt={mainImage.alt || 'Main package image'}
        class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-lg shadow-lg"
      />
      
      {mainImage.caption && (
        <div class="absolute bottom-4 left-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded text-sm">
          {mainImage.caption}
        </div>
      )}
      
      <!-- Image Count Badge -->
      {galleryImages.length > 1 && (
        <div class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm flex items-center">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {galleryImages.length}
        </div>
      )}
    </div>

    <!-- Thumbnail Grid (if more than 1 image) -->
    {thumbnailImages.length > 0 && (
      <div class="grid grid-cols-4 gap-2">
        {thumbnailImages.slice(0, 3).map((image, index) => (
          <div class="relative">
            <img 
              src={image.url}
              alt={image.alt || `Thumbnail ${index + 2}`}
              class="w-full h-16 sm:h-20 object-cover rounded cursor-pointer hover:opacity-75 transition-opacity"
              onclick={`showGalleryImage(${index + 1})`}
            />
          </div>
        ))}
        
        {thumbnailImages.length > 3 && (
          <div class="relative">
            <img 
              src={thumbnailImages[3].url}
              alt="More images"
              class="w-full h-16 sm:h-20 object-cover rounded cursor-pointer"
              onclick="openGalleryModal()"
            />
            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded">
              <span class="text-white text-sm font-semibold">
                +{thumbnailImages.length - 3}
              </span>
            </div>
          </div>
        )}
      </div>
    )}
  </div>

  <!-- View All Button -->
  {galleryImages.length > 1 && (
    <button 
      class="mt-4 w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
      onclick="openGalleryModal()"
    >
      View All {galleryImages.length} Photos
    </button>
  )}
</div>

<!-- Full Gallery Modal -->
<div id="gallery-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="relative max-w-4xl w-full">
      <!-- Close Button -->
      <button 
        class="absolute top-4 right-4 text-white hover:text-gray-300 z-10"
        onclick="closeGalleryModal()"
      >
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <!-- Main Gallery Image -->
      <img 
        id="gallery-main-image"
        src={mainImage.url}
        alt="Gallery image"
        class="w-full max-h-[80vh] object-contain rounded-lg"
      />
      
      <!-- Navigation Arrows -->
      {galleryImages.length > 1 && (
        <>
          <button 
            class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2"
            onclick="prevGalleryImage()"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          
          <button 
            class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2"
            onclick="nextGalleryImage()"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </>
      )}
      
      <!-- Image Counter -->
      <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-50 text-white px-3 py-1 rounded">
        <span id="gallery-counter">1</span> / {galleryImages.length}
      </div>
      
      <!-- Thumbnail Strip -->
      {galleryImages.length > 1 && (
        <div class="absolute bottom-16 left-1/2 transform -translate-x-1/2 flex space-x-2 overflow-x-auto">
          {galleryImages.map((image, index) => (
            <img 
              src={image.url}
              alt={`Thumbnail ${index + 1}`}
              class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-75 gallery-thumb"
              data-index={index}
              onclick={`showGalleryImage(${index})`}
            />
          ))}
        </div>
      )}
    </div>
  </div>
</div>

<script define:vars={{ galleryImages }}>
  let currentImageIndex = 0;
  
  function showGalleryImage(index) {
    currentImageIndex = index;
    const mainImage = document.getElementById('gallery-main-image');
    const counter = document.getElementById('gallery-counter');
    
    if (mainImage && galleryImages[index]) {
      mainImage.src = galleryImages[index].url;
      mainImage.alt = galleryImages[index].alt || `Gallery image ${index + 1}`;
    }
    
    if (counter) {
      counter.textContent = index + 1;
    }
    
    // Update thumbnail selection
    document.querySelectorAll('.gallery-thumb').forEach((thumb, i) => {
      thumb.classList.toggle('opacity-50', i !== index);
    });
  }
  
  function nextGalleryImage() {
    const nextIndex = (currentImageIndex + 1) % galleryImages.length;
    showGalleryImage(nextIndex);
  }
  
  function prevGalleryImage() {
    const prevIndex = currentImageIndex === 0 ? galleryImages.length - 1 : currentImageIndex - 1;
    showGalleryImage(prevIndex);
  }
  
  function openGalleryModal() {
    const modal = document.getElementById('gallery-modal');
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }
  
  function closeGalleryModal() {
    const modal = document.getElementById('gallery-modal');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
  }
  
  // Keyboard navigation
  document.addEventListener('keydown', (event) => {
    const modal = document.getElementById('gallery-modal');
    if (!modal || modal.classList.contains('hidden')) return;
    
    switch (event.key) {
      case 'Escape':
        closeGalleryModal();
        break;
      case 'ArrowLeft':
        prevGalleryImage();
        break;
      case 'ArrowRight':
        nextGalleryImage();
        break;
    }
  });
  
  // Close modal when clicking outside image
  document.getElementById('gallery-modal')?.addEventListener('click', (event) => {
    if (event.target === event.currentTarget) {
      closeGalleryModal();
    }
  });
</script>

<style>
  .package-gallery {
    @apply w-full;
  }
  
  .gallery-thumb {
    @apply ring-2 ring-transparent;
    transition: ring-color 0.2s ease-in-out;
  }
  
  .gallery-thumb:hover {
    @apply ring-white ring-opacity-50;
  }
  
  /* Smooth modal transition */
  #gallery-modal {
    transition: opacity 0.3s ease-in-out;
  }
</style>