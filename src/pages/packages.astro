---
import Layout from '../layouts/Layout.astro';
import PackageCard from '../components/ui/PackageCard.astro';
import { tourPackageRepository } from '../lib/db/repositories/tour-packages.js';
import { fallbackTourPackages } from '../data/fallback-tour-packages.ts';
import type { TourPackage, PackageSearchParams } from '../types/models.js';

const getDatabaseUrl = () => (typeof process !== 'undefined' ? process.env?.DATABASE_URL : undefined);
const hasDatabaseConnection = Boolean(getDatabaseUrl());

// Get search parameters from URL
const url = new URL(Astro.request.url);
const difficultyParam = url.searchParams.get('difficulty');
const searchParams: PackageSearchParams = {
  search: url.searchParams.get('search') || undefined,
  region: url.searchParams.get('region') || undefined,
  difficultyLevel: difficultyParam && ['EASY', 'INTERMEDIATE', 'CHALLENGING'].includes(difficultyParam)
    ? (difficultyParam as any)
    : undefined,
  minPrice: url.searchParams.get('minPrice') ? Number(url.searchParams.get('minPrice')) : undefined,
  maxPrice: url.searchParams.get('maxPrice') ? Number(url.searchParams.get('maxPrice')) : undefined,
  minDuration: url.searchParams.get('minDuration') ? Number(url.searchParams.get('minDuration')) : undefined,
  maxDuration: url.searchParams.get('maxDuration') ? Number(url.searchParams.get('maxDuration')) : undefined,
  page: url.searchParams.get('page') ? Number(url.searchParams.get('page')) : 1,
  limit: 9
};

const getPackagePrice = (pkg: TourPackage) => pkg.price ?? pkg.basePrice ?? 0;

const filterFallbackPackages = (pkgList: TourPackage[], params: PackageSearchParams) => {
  return pkgList.filter((pkg) => {
    const searchTerm = params.search?.toLowerCase();
    const matchesSearch = searchTerm
      ? [pkg.title, pkg.shortDescription, pkg.description]
          .filter(Boolean)
          .some((field) => field!.toLowerCase().includes(searchTerm))
      : true;

    const matchesRegion = params.region
      ? pkg.region?.toLowerCase() === params.region.toLowerCase()
      : true;

    const matchesDifficulty = params.difficultyLevel
      ? pkg.difficultyLevel === params.difficultyLevel
      : true;

    const price = getPackagePrice(pkg);
    const matchesMinPrice = params.minPrice ? price >= params.minPrice : true;
    const matchesMaxPrice = params.maxPrice ? price <= params.maxPrice : true;

    const matchesMinDuration = params.minDuration ? pkg.duration >= params.minDuration : true;
    const matchesMaxDuration = params.maxDuration ? pkg.duration <= params.maxDuration : true;

    return (
      matchesSearch &&
      matchesRegion &&
      matchesDifficulty &&
      matchesMinPrice &&
      matchesMaxPrice &&
      matchesMinDuration &&
      matchesMaxDuration
    );
  });
};

const getFallbackRegions = (pkgList: TourPackage[]) =>
  Array.from(new Set(pkgList.map((pkg) => pkg.region).filter(Boolean))).sort();

const getFallbackPriceRange = (pkgList: TourPackage[]) => {
  const prices = pkgList.map(getPackagePrice).filter((price) => price > 0);
  return prices.length
    ? { min: Math.min(...prices), max: Math.max(...prices) }
    : { min: 0, max: 0 };
};

const getFallbackDurationRange = (pkgList: TourPackage[]) => {
  const durations = pkgList.map((pkg) => pkg.duration).filter((duration) => typeof duration === 'number');
  return durations.length
    ? { min: Math.min(...durations), max: Math.max(...durations) }
    : { min: 0, max: 0 };
};

const applyFallbackPackages = () => {
  const fallbackList = fallbackTourPackages as TourPackage[];
  const filtered = filterFallbackPackages(fallbackList, searchParams);
  totalCount = filtered.length;
  const limit = searchParams.limit ?? 9;
  const currentPage = searchParams.page ?? 1;
  const start = (currentPage - 1) * limit;
  packages = filtered.slice(start, start + limit);
  regions = getFallbackRegions(fallbackList);
  priceRange = getFallbackPriceRange(fallbackList);
  durationRange = getFallbackDurationRange(fallbackList);
};

// Fetch packages and filters
let packages: TourPackage[] = [];
let totalCount = 0;
let regions: string[] = [];
let priceRange = { min: 0, max: 1000 };
let durationRange = { min: 1, max: 14 };

if (hasDatabaseConnection) {
  try {
    const result = await tourPackageRepository.findMany(searchParams);
    packages = result.packages;
    totalCount = (result as any).total ?? (result as any).totalCount ?? packages.length;

    // Get filter options
    regions = await tourPackageRepository.getRegions();
    priceRange = await tourPackageRepository.getPriceRange();
    durationRange = await tourPackageRepository.getDurationRange();
  } catch (error) {
    console.error('Failed to load packages:', error);
    applyFallbackPackages();
  }
} else {
  applyFallbackPackages();
}

// Calculate pagination
const totalPages = Math.ceil(totalCount / searchParams.limit!);
const currentPage = searchParams.page || 1;
---

<Layout 
  title={searchParams.search ? `Search Results for "${searchParams.search}" - Cycle Paradise` : "Tour Packages - Cycle Paradise"}
  description="Explore our comprehensive collection of cycling tour packages in Sri Lanka. From easy coastal rides to challenging mountain adventures, find your perfect cycling holiday."
>
  <!-- Page Header -->
  <section class="relative py-16 -mt-[72px]">
    <!-- Background Image with Overlay -->
    <div class="absolute inset-0 z-0">
      <img
        src="https://images.unsplash.com/photo-1541625602330-2277a4c46182?q=80&w=2070&auto=format&fit=crop"
        alt="Cyclist riding through scenic Sri Lankan landscape"
        class="w-full h-full object-cover"
      />
      <!-- Dark overlay for better text contrast -->
      <div class="absolute inset-0 bg-gradient-to-r from-black/70 via-black/50 to-black/30"></div>
    </div>

    <!-- Header Content -->
    <div class="relative z-10 mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-32">
      <div class="text-center">
        <h1 class="font-display font-bold text-4xl text-white sm:text-5xl">
          {searchParams.search ? `Search Results` : 'Tour Packages'}
        </h1>
        {searchParams.search && (
          <p class="mt-4 text-lg text-gray-100">
            Results for "<span class="font-semibold text-primary-400">{searchParams.search}</span>"
          </p>
        )}
        <p class="mt-2 text-gray-100">
          Showing {packages.length} of {totalCount} packages
        </p>
      </div>
    </div>
  </section>

  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <!-- Mobile Filter Toggle Button -->
    <div class="mb-4 lg:hidden">
      <button
        type="button"
        id="mobile-filter-toggle"
        class="w-full flex items-center justify-between px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all focus:outline-none focus:ring-2 focus:ring-primary-500"
      >
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
          </svg>
          <span class="font-semibold text-gray-900">Filters</span>
        </div>
        <svg id="filter-chevron" class="w-5 h-5 text-gray-600 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
    </div>

    <div class="lg:grid lg:grid-cols-4 lg:gap-8">
      <!-- Filters Sidebar -->
      <div id="filter-sidebar" class="mb-8 lg:mb-0 hidden lg:block">
        <form id="filter-form" class="space-y-6">
          <!-- Search -->
          <div>
            <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
              Search Packages
            </label>
            <input
              type="text"
              id="search"
              name="search"
              value={searchParams.search || ''}
              placeholder="Search by name or description..."
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            />
          </div>

          <!-- Region Filter -->
          <div>
            <label for="region" class="block text-sm font-medium text-gray-700 mb-2">
              Region
            </label>
            <select
              id="region"
              name="region"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">All Regions</option>
              {regions.map(region => (
                <option value={region} selected={searchParams.region === region}>
                  {region}
                </option>
              ))}
            </select>
          </div>

          <!-- Difficulty Filter -->
          <div>
            <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-2">
              Difficulty Level
            </label>
            <select
              id="difficulty"
              name="difficulty"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">All Levels</option>
              <option value="EASY" selected={searchParams.difficultyLevel?.toString() === 'EASY'}>Easy</option>
              <option value="INTERMEDIATE" selected={searchParams.difficultyLevel?.toString() === 'INTERMEDIATE'}>Intermediate</option>
              <option value="CHALLENGING" selected={searchParams.difficultyLevel?.toString() === 'CHALLENGING'}>Challenging</option>
            </select>
          </div>

          <!-- Price Range -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Price Range (USD)
            </label>
            <div class="px-2 pt-2">
              <div class="flex justify-between mb-3">
                <span class="text-sm font-semibold text-primary-600" id="price-min-display">${searchParams.minPrice || priceRange.min}</span>
                <span class="text-sm font-semibold text-primary-600" id="price-max-display">${searchParams.maxPrice || priceRange.max}</span>
              </div>
              <div class="relative">
                <input
                  type="range"
                  id="minPrice"
                  name="minPrice"
                  min={priceRange.min}
                  max={priceRange.max}
                  value={searchParams.minPrice || priceRange.min}
                  class="price-range-slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                />
                <input
                  type="range"
                  id="maxPrice"
                  name="maxPrice"
                  min={priceRange.min}
                  max={priceRange.max}
                  value={searchParams.maxPrice || priceRange.max}
                  class="price-range-slider w-full h-2 bg-transparent rounded-lg appearance-none cursor-pointer absolute top-0 left-0"
                />
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-3 px-2">
              Available: ${priceRange.min} - ${priceRange.max}
            </p>
          </div>

          <!-- Duration Filter -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Duration (Days)
            </label>
            <div class="grid grid-cols-2 gap-3">
              <button
                type="button"
                data-duration="4"
                class="duration-btn px-4 py-3 border-2 border-gray-300 rounded-lg text-center hover:border-primary-500 hover:bg-primary-50 transition-all focus:outline-none focus:ring-2 focus:ring-primary-500"
              >
                <div class="text-xl font-semibold text-gray-900">4</div>
                <div class="text-xs text-gray-600 mt-1">days</div>
              </button>
              <button
                type="button"
                data-duration="5"
                class="duration-btn px-4 py-3 border-2 border-gray-300 rounded-lg text-center hover:border-primary-500 hover:bg-primary-50 transition-all focus:outline-none focus:ring-2 focus:ring-primary-500"
              >
                <div class="text-xl font-semibold text-gray-900">5</div>
                <div class="text-xs text-gray-600 mt-1">days</div>
              </button>
            </div>
            <input type="hidden" id="duration" name="duration" value="" />
          </div>

          <!-- Filter Actions -->
          <div class="space-y-2">
            <button
              type="submit"
              class="w-full bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors"
            >
              Apply Filters
            </button>
            <button
              type="button"
              id="clear-filters"
              class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
            >
              Clear Filters
            </button>
          </div>
        </form>
      </div>

      <!-- Package Results -->
      <div class="lg:col-span-3">
        {packages.length > 0 ? (
          <>
            <!-- Package Grid -->
            <div class="grid grid-cols-1 gap-8 sm:grid-cols-2 xl:grid-cols-3">
              {packages.map((tourPackage) => (
                <PackageCard package={tourPackage} />
              ))}
            </div>

            <!-- Pagination -->
            {totalPages > 1 && (
              <div class="mt-12 flex items-center justify-between">
                <div class="text-sm text-gray-700">
                  Showing page {currentPage} of {totalPages}
                </div>
                
                <nav class="flex items-center space-x-2">
                  {currentPage > 1 && (
                    <a
                      href={`/packages?${new URLSearchParams({...Object.fromEntries(url.searchParams), page: (currentPage - 1).toString()})}`}
                      class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50"
                    >
                      Previous
                    </a>
                  )}
                  
                  {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                    const pageNum = Math.max(1, Math.min(totalPages, currentPage - 2 + i));
                    return (
                      <a
                        href={`/packages?${new URLSearchParams({...Object.fromEntries(url.searchParams), page: pageNum.toString()})}`}
                        class={`px-3 py-2 text-sm font-medium rounded-md ${
                          pageNum === currentPage
                            ? 'bg-primary-600 text-white'
                            : 'text-gray-500 hover:text-gray-700 border border-gray-300 hover:bg-gray-50'
                        }`}
                      >
                        {pageNum}
                      </a>
                    );
                  })}
                  
                  {currentPage < totalPages && (
                    <a
                      href={`/packages?${new URLSearchParams({...Object.fromEntries(url.searchParams), page: (currentPage + 1).toString()})}`}
                      class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50"
                    >
                      Next
                    </a>
                  )}
                </nav>
              </div>
            )}
          </>
        ) : (
          <!-- No Results -->
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.217-5.417-3.034A8.002 8.002 0 012 9c0-4.418 3.582-8 8-8s8 3.582 8 8a8.002 8.002 0 01-4.583 7.034A7.962 7.962 0 0112 15z"/>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No packages found</h3>
            <p class="mt-1 text-sm text-gray-500">
              Try adjusting your filters or search terms.
            </p>
            <div class="mt-6">
              <button
                type="button"
                id="clear-all-filters"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 bg-primary-100 hover:bg-primary-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
              >
                Clear All Filters
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>

<script>
  // Filter form handling
  document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const clearAllFiltersBtn = document.getElementById('clear-all-filters');

    // Mobile filter toggle
    const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
    const filterSidebar = document.getElementById('filter-sidebar');
    const filterChevron = document.getElementById('filter-chevron');

    if (mobileFilterToggle && filterSidebar && filterChevron) {
      mobileFilterToggle.addEventListener('click', function() {
        const isHidden = filterSidebar.classList.contains('hidden');
        
        if (isHidden) {
          filterSidebar.classList.remove('hidden');
          filterChevron.classList.add('rotate-180');
        } else {
          filterSidebar.classList.add('hidden');
          filterChevron.classList.remove('rotate-180');
        }
      });
    }

    if (filterForm && filterForm instanceof HTMLFormElement) {
      filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(filterForm);
        const params = new URLSearchParams();
        
        for (const [key, value] of formData.entries()) {
          if (value && value.toString().trim()) {
            params.append(key, value.toString());
          }
        }
        
        // Reset to page 1 when applying new filters
        params.set('page', '1');
        
        window.location.href = `/packages?${params.toString()}`;
      });
    }

    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', function() {
        window.location.href = '/packages';
      });
    }

    if (clearAllFiltersBtn) {
      clearAllFiltersBtn.addEventListener('click', function() {
        window.location.href = '/packages';
      });
    }

    // Auto-submit on select changes for better UX
    const selectInputs = filterForm?.querySelectorAll('select');
    selectInputs?.forEach(select => {
      select.addEventListener('change', function() {
        if (filterForm && filterForm instanceof HTMLFormElement) {
          filterForm.dispatchEvent(new Event('submit'));
        }
      });
    });

    // Duration button handling
    const durationButtons = document.querySelectorAll('.duration-btn');
    const durationInput = document.getElementById('duration');
    
    durationButtons.forEach(button => {
      button.addEventListener('click', function() {
        const duration = this.getAttribute('data-duration');
        
        // Toggle selection
        if (this.classList.contains('active-duration')) {
          this.classList.remove('active-duration', 'border-primary-600', 'bg-primary-100');
          this.classList.add('border-gray-300');
          if (durationInput) durationInput.value = '';
        } else {
          // Remove active from all buttons
          durationButtons.forEach(btn => {
            btn.classList.remove('active-duration', 'border-primary-600', 'bg-primary-100');
            btn.classList.add('border-gray-300');
          });
          
          // Add active to clicked button
          this.classList.add('active-duration', 'border-primary-600', 'bg-primary-100');
          this.classList.remove('border-gray-300');
          if (durationInput) durationInput.value = duration;
        }
      });
    });

    // Range slider functionality
    function setupRangeSlider(minId, maxId, minDisplayId, maxDisplayId, prefix = '') {
      const minSlider = document.getElementById(minId);
      const maxSlider = document.getElementById(maxId);
      const minDisplay = document.getElementById(minDisplayId);
      const maxDisplay = document.getElementById(maxDisplayId);

      if (!minSlider || !maxSlider || !minDisplay || !maxDisplay) return;

      function updateValues() {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);

        // Ensure min doesn't exceed max
        if (minVal > maxVal) {
          minSlider.value = maxVal;
          minVal = maxVal;
        }

        // Enable pointer events on the appropriate slider
        if (minVal === maxVal) {
          maxSlider.style.pointerEvents = 'all';
          minSlider.style.pointerEvents = 'none';
        } else {
          maxSlider.style.pointerEvents = 'all';
          minSlider.style.pointerEvents = 'all';
        }

        // Update displays
        minDisplay.textContent = prefix + minVal;
        maxDisplay.textContent = prefix + maxVal;

        // Update the visual track fill
        updateSliderTrack(minSlider, maxSlider);
      }

      function updateSliderTrack(minSlider, maxSlider) {
        const min = parseInt(minSlider.min);
        const max = parseInt(minSlider.max);
        const minVal = parseInt(minSlider.value);
        const maxVal = parseInt(maxSlider.value);

        const percentMin = ((minVal - min) / (max - min)) * 100;
        const percentMax = ((maxVal - min) / (max - min)) * 100;

        // Apply gradient to show selected range with primary green color
        minSlider.style.background = `linear-gradient(to right, #e5e7eb 0%, #e5e7eb ${percentMin}%, #22c57a ${percentMin}%, #22c57a ${percentMax}%, #e5e7eb ${percentMax}%, #e5e7eb 100%)`;
      }

      minSlider.addEventListener('input', updateValues);
      maxSlider.addEventListener('input', updateValues);

      // Initialize
      updateValues();
    }

    // Setup price range slider
    setupRangeSlider('minPrice', 'maxPrice', 'price-min-display', 'price-max-display', '$');
  });
</script>

<style>
  /* Custom range slider styling */
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #22c57a;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    pointer-events: all;
    position: relative;
    z-index: 100;
  }

  input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #22c57a;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    pointer-events: all;
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    background: #0F6745;
    transform: scale(1.1);
  }

  input[type="range"]::-moz-range-thumb:hover {
    background: #0F6745;
    transform: scale(1.1);
  }

  input[type="range"]:focus {
    outline: none;
  }

  input[type="range"]:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 3px rgba(34, 197, 122, 0.3);
  }

  input[type="range"]:focus::-moz-range-thumb {
    box-shadow: 0 0 0 3px rgba(34, 197, 122, 0.3);
  }

  /* Track styling for Firefox */
  input[type="range"]::-moz-range-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 4px;
  }

  input[type="range"]::-moz-range-progress {
    background: #22c57a;
    height: 8px;
    border-radius: 4px;
  }