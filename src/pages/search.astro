---
import Layout from '../layouts/Layout.astro';
import PackageCard from '../components/ui/PackageCard.astro';
import { tourPackageRepository } from '../lib/db/repositories/tour-packages.js';
import { cyclingGuideRepository } from '../lib/db/repositories/cycling-guides.js';
import type { TourPackage, CyclingGuide } from '../types/models.js';

// Get search query from URL
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
const type = url.searchParams.get('type') || 'all'; // 'all', 'packages', 'guides'
const page = Number(url.searchParams.get('page')) || 1;
const limit = 12;

// Search results
let packages: TourPackage[] = [];
let guides: CyclingGuide[] = [];
let totalPackages = 0;
let totalGuides = 0;
let totalResults = 0;

if (query.trim()) {
  try {
    // Search packages
    if (type === 'all' || type === 'packages') {
      const packageResults = await tourPackageRepository.search(query, {
        page: type === 'packages' ? page : 1,
        limit: type === 'packages' ? limit : 5
      });
      packages = packageResults.packages;
      totalPackages = packageResults.totalCount;
    }

    // Search guides
    if (type === 'all' || type === 'guides') {
      const guideResults = await cyclingGuideRepository.search(query, {
        page: type === 'guides' ? page : 1,
        limit: type === 'guides' ? limit : 5
      });
      guides = guideResults.guides;
      totalGuides = guideResults.totalCount;
    }

    totalResults = totalPackages + totalGuides;
  } catch (error) {
    console.error('Search failed:', error);
    // Use fallback search results
    if (query.toLowerCase().includes('hill')) {
      packages = [{
        id: 1,
        title: "Hill Country Explorer",
        slug: "hill-country-explorer",
        description: "Cycle through misty tea plantations and charming hill stations in Sri Lanka's central highlands.",
        shortDescription: "Tea plantations and hill stations adventure",
        price: 299,
        duration: 7,
        difficultyLevel: "INTERMEDIATE" as const,
        maxGroupSize: 12,
        images: ["/images/hill-country-1.jpg"],
        videoUrl: null,
        isActive: true,
        isFeatured: true,
        region: "Central",
        includedServices: ["Bike rental", "Guide", "Accommodation"],
        excludedServices: [],
        highlights: ["Tea factory visits", "Scenic mountain views"],
        itinerary: [],
        whatToBring: [],
        accommodation: [],
        createdAt: new Date(),
        updatedAt: new Date()
      }];
      totalPackages = 1;
      totalResults = 1;
    }
  }
}

// Calculate pagination for filtered results
const totalPages = type === 'packages' ? Math.ceil(totalPackages / limit) :
                   type === 'guides' ? Math.ceil(totalGuides / limit) :
                   Math.ceil(Math.max(totalPackages, totalGuides) / limit);

// Helper function to get difficulty badge color
function getDifficultyColor(level: string): string {
  switch (level) {
    case 'EASY': return 'bg-green-100 text-green-800';
    case 'INTERMEDIATE': return 'bg-yellow-100 text-yellow-800';
    case 'CHALLENGING': return 'bg-red-100 text-red-800';
    default: return 'bg-gray-100 text-gray-800';
  }
}
---

<Layout 
  title={query ? `Search Results for "${query}" - Cycle Paradise` : "Search - Cycle Paradise"}
  description={query ? `Find cycling tours and guides matching "${query}" in Sri Lanka.` : "Search for cycling tour packages and guides in Sri Lanka."}
>
  <!-- Search Header -->
  <section class="bg-gradient-to-b from-primary-50 to-white py-16">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h1 class="font-display font-bold text-4xl text-gray-900 sm:text-5xl mb-6">
          {query ? 'Search Results' : 'Search Tours & Guides'}
        </h1>
        
        {query && (
          <div class="mb-6">
            <p class="text-lg text-gray-600 mb-2">
              Results for "<span class="font-semibold text-primary-600">{query}</span>"
            </p>
            <p class="text-gray-500">
              {totalResults} result{totalResults !== 1 ? 's' : ''} found
            </p>
          </div>
        )}

        <!-- Search Form -->
        <div class="max-w-2xl mx-auto">
          <form id="search-form" class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
              <input
                type="text"
                name="q"
                value={query}
                placeholder="Search tours, guides, destinations..."
                class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                autofocus
              />
            </div>
            <button
              type="submit"
              class="px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors"
            >
              <span class="sm:hidden">Search</span>
              <span class="hidden sm:inline">Search</span>
              <svg class="w-5 h-5 ml-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>
  </section>

  {query.trim() ? (
    <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
      <!-- Filter Tabs -->
      <div class="mb-8">
        <nav class="flex space-x-8 border-b border-gray-200">
          <a 
            href={`/search?q=${encodeURIComponent(query)}&type=all`}
            class={`py-4 px-1 border-b-2 font-medium text-sm ${
              type === 'all' 
                ? 'border-primary-500 text-primary-600' 
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
          >
            All Results ({totalResults})
          </a>
          <a 
            href={`/search?q=${encodeURIComponent(query)}&type=packages`}
            class={`py-4 px-1 border-b-2 font-medium text-sm ${
              type === 'packages' 
                ? 'border-primary-500 text-primary-600' 
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
          >
            Tour Packages ({totalPackages})
          </a>
          <a 
            href={`/search?q=${encodeURIComponent(query)}&type=guides`}
            class={`py-4 px-1 border-b-2 font-medium text-sm ${
              type === 'guides' 
                ? 'border-primary-500 text-primary-600' 
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
          >
            Cycling Guides ({totalGuides})
          </a>
        </nav>
      </div>

      <!-- Results Content -->
      {totalResults > 0 ? (
        <div class="space-y-12">
          <!-- Tour Packages Results -->
          {((type === 'all' && packages.length > 0) || type === 'packages') && (
            <section>
              <div class="flex items-center justify-between mb-6">
                <h2 class="font-display font-bold text-2xl text-gray-900">
                  Tour Packages
                  {type === 'all' && totalPackages > packages.length && (
                    <span class="text-lg text-gray-600 font-normal ml-2">
                      (showing {packages.length} of {totalPackages})
                    </span>
                  )}
                </h2>
                {type === 'all' && totalPackages > packages.length && (
                  <a 
                    href={`/search?q=${encodeURIComponent(query)}&type=packages`}
                    class="text-primary-600 hover:text-primary-700 font-medium"
                  >
                    View all packages →
                  </a>
                )}
              </div>
              
              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                {packages.map((tourPackage) => (
                  <PackageCard package={tourPackage} />
                ))}
              </div>
            </section>
          )}

          <!-- Cycling Guides Results -->
          {((type === 'all' && guides.length > 0) || type === 'guides') && (
            <section>
              <div class="flex items-center justify-between mb-6">
                <h2 class="font-display font-bold text-2xl text-gray-900">
                  Cycling Guides
                  {type === 'all' && totalGuides > guides.length && (
                    <span class="text-lg text-gray-600 font-normal ml-2">
                      (showing {guides.length} of {totalGuides})
                    </span>
                  )}
                </h2>
                {type === 'all' && totalGuides > guides.length && (
                  <a 
                    href={`/search?q=${encodeURIComponent(query)}&type=guides`}
                    class="text-primary-600 hover:text-primary-700 font-medium"
                  >
                    View all guides →
                  </a>
                )}
              </div>
              
              <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3">
                {guides.map((guide) => (
                  <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                    <!-- Guide Image -->
                    <div class="aspect-w-16 aspect-h-10">
                      <img 
                        src={guide.images[0] || "/images/default-route.jpg"} 
                        alt={guide.title}
                        class="w-full h-48 object-cover"
                      />
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6">
                      <!-- Header -->
                      <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-2">
                          <span class={`px-2 py-1 rounded-full text-xs font-medium ${getDifficultyColor(guide.difficultyLevel)}`}>
                            {guide.difficultyLevel.toLowerCase()}
                          </span>
                          <span class="text-sm text-gray-600">{guide.region}</span>
                        </div>
                      </div>

                      <!-- Title and Description -->
                      <h3 class="font-display font-bold text-xl text-gray-900 mb-2">
                        <a href={`/guides/${guide.slug}`} class="hover:text-primary-600 transition-colors">
                          {guide.title}
                        </a>
                      </h3>
                      
                      <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                        {guide.shortDescription}
                      </p>

                      <!-- Route Stats -->
                      <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div class="flex items-center text-gray-600">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                          </svg>
                          <span>{guide.estimatedDistance} km</span>
                        </div>
                        
                        <div class="flex items-center text-gray-600">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                          </svg>
                          <span>{guide.estimatedDuration}</span>
                        </div>
                      </div>

                      <!-- Action Button -->
                      <a 
                        href={`/guides/${guide.slug}`}
                        class="w-full bg-primary-600 text-white py-2 px-4 rounded-md text-center font-medium hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors inline-block"
                      >
                        View Guide
                      </a>
                    </div>
                  </article>
                ))}
              </div>
            </section>
          )}

          <!-- Pagination for filtered results -->
          {totalPages > 1 && type !== 'all' && (
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-700">
                Showing page {page} of {totalPages}
              </div>
              
              <nav class="flex items-center space-x-2">
                {page > 1 && (
                  <a
                    href={`/search?q=${encodeURIComponent(query)}&type=${type}&page=${page - 1}`}
                    class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50"
                  >
                    Previous
                  </a>
                )}
                
                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                  const pageNum = Math.max(1, Math.min(totalPages, page - 2 + i));
                  return (
                    <a
                      href={`/search?q=${encodeURIComponent(query)}&type=${type}&page=${pageNum}`}
                      class={`px-3 py-2 text-sm font-medium rounded-md ${
                        pageNum === page
                          ? 'bg-primary-600 text-white'
                          : 'text-gray-500 hover:text-gray-700 border border-gray-300 hover:bg-gray-50'
                      }`}
                    >
                      {pageNum}
                    </a>
                  );
                })}
                
                {page < totalPages && (
                  <a
                    href={`/search?q=${encodeURIComponent(query)}&type=${type}&page=${page + 1}`}
                    class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50"
                  >
                    Next
                  </a>
                )}
              </nav>
            </div>
          )}
        </div>
      ) : (
        <!-- No Results -->
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">No results found</h3>
          <p class="mt-1 text-sm text-gray-500">
            Try different keywords or browse our popular tours below.
          </p>
          
          <!-- Suggestions -->
          <div class="mt-6">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Popular searches:</h4>
            <div class="flex flex-wrap justify-center gap-2">
              <a href="/search?q=hill%20country" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                Hill Country
              </a>
              <a href="/search?q=coastal" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                Coastal
              </a>
              <a href="/search?q=cultural" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                Cultural
              </a>
              <a href="/search?q=sigiriya" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                Sigiriya
              </a>
              <a href="/search?q=galle" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                Galle
              </a>
            </div>
          </div>

          <div class="mt-8 space-y-2">
            <a 
              href="/packages"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 bg-primary-100 hover:bg-primary-200 mr-3"
            >
              Browse All Packages
            </a>
            <a 
              href="/guides"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 bg-primary-100 hover:bg-primary-200"
            >
              Browse All Guides
            </a>
          </div>
        </div>
      )}
    </div>
  ) : (
    <!-- Search Landing Page -->
    <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
      <!-- Quick Search Categories -->
      <section class="mb-16">
        <h2 class="font-display font-bold text-2xl text-gray-900 text-center mb-8">
          Popular Search Categories
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <a href="/search?q=hill%20country" class="group bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
            <div class="aspect-w-16 aspect-h-9 bg-gradient-to-r from-green-400 to-green-600">
              <div class="flex items-center justify-center">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">Hill Country</h3>
              <p class="text-sm text-gray-600">Mountain trails & tea plantations</p>
            </div>
          </a>

          <a href="/search?q=coastal" class="group bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
            <div class="aspect-w-16 aspect-h-9 bg-gradient-to-r from-blue-400 to-blue-600">
              <div class="flex items-center justify-center">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"/>
                </svg>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">Coastal Routes</h3>
              <p class="text-sm text-gray-600">Beach rides & fishing villages</p>
            </div>
          </a>

          <a href="/search?q=cultural" class="group bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
            <div class="aspect-w-16 aspect-h-9 bg-gradient-to-r from-purple-400 to-purple-600">
              <div class="flex items-center justify-center">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">Cultural Sites</h3>
              <p class="text-sm text-gray-600">Ancient temples & heritage</p>
            </div>
          </a>

          <a href="/search?q=adventure" class="group bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
            <div class="aspect-w-16 aspect-h-9 bg-gradient-to-r from-red-400 to-red-600">
              <div class="flex items-center justify-center">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">Adventure</h3>
              <p class="text-sm text-gray-600">Challenging routes & expeditions</p>
            </div>
          </a>
        </div>
      </section>

      <!-- Search Tips -->
      <section class="bg-gray-50 rounded-lg p-8">
        <h3 class="font-display font-bold text-xl text-gray-900 mb-4 text-center">
          Search Tips
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
          <div class="text-center">
            <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              </svg>
            </div>
            <h4 class="font-medium text-gray-900 mb-2">Search by Location</h4>
            <p class="text-gray-600">Try "Sigiriya", "Galle", "Ella", or "Kandy"</p>
          </div>

          <div class="text-center">
            <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
              </svg>
            </div>
            <h4 class="font-medium text-gray-900 mb-2">Search by Activity</h4>
            <p class="text-gray-600">Try "mountain biking", "easy ride", or "challenging"</p>
          </div>

          <div class="text-center">
            <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <h4 class="font-medium text-gray-900 mb-2">Search by Duration</h4>
            <p class="text-gray-600">Try "day trip", "week long", or "5 days"</p>
          </div>
        </div>
      </section>
    </div>
  )}
</Layout>

<script>
  // Enhanced search form handling
  document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    
    if (searchForm) {
      searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(searchForm);
        const query = formData.get('q')?.toString().trim();
        
        if (query) {
          window.location.href = `/search?q=${encodeURIComponent(query)}`;
        }
      });
    }

    // Search suggestions (could be enhanced with real-time search)
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchForm?.dispatchEvent(new Event('submit'));
        }
      });
    }
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>