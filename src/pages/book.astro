---
import Layout from '../layouts/Layout.astro';

// Get pre-filled data from URL params (when coming from package page)
const url = new URL(Astro.request.url);
const preSelectedPackage = url.searchParams.get('package');
const packageTitle = url.searchParams.get('title');
const packagePrice = url.searchParams.get('price');

const pageTitle = preSelectedPackage
  ? `Book ${packageTitle} - Cycle Paradise`
  : 'Book Your Cycling Adventure - Cycle Paradise';
---

<Layout
  title={pageTitle}
  description="Book your Sri Lankan cycling adventure with Cycle Paradise. Choose your tour package, select dates, and start your journey."
>
  <main class="min-h-screen bg-gray-50 py-12">
    <div class="container mx-auto px-4 max-w-4xl">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Book Your Adventure</h1>
        <p class="text-lg text-gray-600">Complete the form below to reserve your cycling tour</p>
      </div>

      <!-- Booking Form -->
      <div class="bg-white rounded-lg shadow-lg p-8">
        <form id="booking-form" class="space-y-6">
          <!-- Step 1: Package Selection -->
          <div class="border-b pb-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">1. Select Your Tour Package</h2>
            <div>
              <label for="package" class="block text-sm font-medium text-gray-700 mb-2">
                Tour Package <span class="text-red-500">*</span>
              </label>
              <select
                id="package"
                name="package"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              >
                <option value="">Select a tour package...</option>
                <option
                  value="hill-country-explorer"
                  data-price="1299"
                  selected={preSelectedPackage === 'hill-country-explorer'}
                >
                  Hill Country Explorer - 7 Days ($1,299)
                </option>
                <option
                  value="coastal-adventure"
                  data-price="1499"
                  selected={preSelectedPackage === 'coastal-adventure'}
                >
                  Coastal Adventure - 10 Days ($1,499)
                </option>
                <option
                  value="cultural-triangle"
                  data-price="1899"
                  selected={preSelectedPackage === 'cultural-triangle'}
                >
                  Cultural Triangle Journey - 14 Days ($1,899)
                </option>
              </select>
            </div>
          </div>

          <!-- Step 2: Travel Dates -->
          <div class="border-b pb-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">2. Choose Your Dates</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">
                  Start Date <span class="text-red-500">*</span>
                </label>
                <input
                  type="date"
                  id="start-date"
                  name="start-date"
                  required
                  autocomplete="off"
                  min={new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
                <p class="text-xs text-gray-500 mt-1">Minimum 7 days advance booking required</p>
              </div>
              <div>
                <label for="end-date" class="block text-sm font-medium text-gray-700 mb-2">
                  End Date <span class="text-red-500">*</span>
                </label>
                <input
                  type="date"
                  id="end-date"
                  name="end-date"
                  required
                  autocomplete="off"
                  readonly
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
                />
                <p class="text-xs text-gray-500 mt-1">Auto-calculated based on tour duration</p>
              </div>
            </div>
          </div>

          <!-- Step 3: Guest Information -->
          <div class="border-b pb-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">3. Guest Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="guests" class="block text-sm font-medium text-gray-700 mb-2">
                  Number of Guests <span class="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  id="guests"
                  name="guests"
                  min="1"
                  max="12"
                  value="2"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
              </div>
              <div>
                <label for="accommodation" class="block text-sm font-medium text-gray-700 mb-2">
                  Accommodation Preference <span class="text-red-500">*</span>
                </label>
                <select
                  id="accommodation"
                  name="accommodation"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                >
                  <option value="twin">Twin Sharing</option>
                  <option value="single">Single Room (+$200)</option>
                  <option value="double">Double Room</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Step 4: Personal Information -->
          <div class="border-b pb-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">4. Your Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="first-name" class="block text-sm font-medium text-gray-700 mb-2">
                  First Name <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="first-name"
                  name="first-name"
                  required
                  autocomplete="given-name"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
              </div>
              <div>
                <label for="last-name" class="block text-sm font-medium text-gray-700 mb-2">
                  Last Name <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="last-name"
                  name="last-name"
                  required
                  autocomplete="family-name"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
              </div>
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                  Email Address <span class="text-red-500">*</span>
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  autocomplete="email"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
              </div>
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                  Phone Number <span class="text-red-500">*</span>
                </label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  required
                  autocomplete="tel"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
              </div>
              <div class="md:col-span-2">
                <label for="country" class="block text-sm font-medium text-gray-700 mb-2">
                  Country <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="country"
                  name="country"
                  required
                  autocomplete="country-name"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                />
              </div>
            </div>
          </div>

          <!-- Step 5: Special Requests -->
          <div class="border-b pb-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">5. Additional Information</h2>
            <div>
              <label for="special-requests" class="block text-sm font-medium text-gray-700 mb-2">
                Special Requests or Dietary Requirements
              </label>
              <textarea
                id="special-requests"
                name="special-requests"
                rows="4"
                placeholder="Please let us know about any dietary restrictions, fitness level concerns, or special requests..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              ></textarea>
            </div>
          </div>

          <!-- Price Summary -->
          <div class="bg-gray-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Booking Summary</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Package Price (per person):</span>
                <span class="font-medium" id="base-price">$0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Number of Guests:</span>
                <span class="font-medium" id="guest-count">2</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Accommodation Supplement:</span>
                <span class="font-medium" id="accommodation-fee">$0</span>
              </div>
              <div class="border-t border-gray-300 pt-2 mt-2 flex justify-between text-lg">
                <span class="font-semibold text-gray-900">Total Estimate:</span>
                <span class="font-bold text-primary-600" id="total-price">$0</span>
              </div>
              <p class="text-xs text-gray-500 mt-2">
                * Final price will be confirmed after reviewing your booking. A 30% deposit is
                required to secure your reservation.
              </p>
            </div>
          </div>

          <!-- Terms and Submit -->
          <div class="space-y-4">
            <div class="flex items-start">
              <input
                type="checkbox"
                id="terms"
                name="terms"
                required
                class="mt-1 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
              />
              <label for="terms" class="ml-2 text-sm text-gray-600">
                I agree to the <a
                  href="/terms"
                  class="text-primary-600 hover:text-primary-700 underline">Terms & Conditions</a
                >
                and <a href="/privacy" class="text-primary-600 hover:text-primary-700 underline"
                  >Privacy Policy</a
                >
                <span class="text-red-500">*</span>
              </label>
            </div>

            <div id="form-status" class="hidden rounded-lg p-4"></div>

            <button
              type="submit"
              id="submit-btn"
              class="w-full bg-primary-600 text-white font-semibold py-4 px-6 rounded-lg hover:bg-primary-700 transition-colors flex items-center justify-center"
            >
              <span>Submit Booking Request</span>
              <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
              </svg>
            </button>
          </div>
        </form>
      </div>

      <!-- Additional Info -->
      <div class="mt-8 text-center text-sm text-gray-600">
        <p>
          Need help? Contact us at <a
            href="mailto:bookings@cycleparadise.lk"
            class="text-primary-600 hover:text-primary-700">bookings@cycleparadise.lk</a
          >
          or call <a href="tel:+94123456789" class="text-primary-600 hover:text-primary-700"
            >+94 12 345 6789</a>
        </p>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Package data with durations
      const packageData = {
        'hill-country-explorer': { price: 1299, duration: 7 },
        'coastal-adventure': { price: 1499, duration: 10 },
        'cultural-triangle': { price: 1899, duration: 14 },
      };

      // Get form elements
      const form = document.getElementById('booking-form');
      const packageSelect = document.getElementById('package');
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      const guestsInput = document.getElementById('guests');
      const accommodationSelect = document.getElementById('accommodation');
      const statusDiv = document.getElementById('form-status');
      const submitBtn = document.getElementById('submit-btn');

      // Helper: Add days to date string safely (using UTC)
      function addDaysToDate(dateStr, days) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '';
        
        // Set to noon UTC to avoid any timezone rollover issues
        date.setUTCHours(12, 0, 0, 0);
        date.setUTCDate(date.getUTCDate() + days);
        return date.toISOString().split('T')[0];
      }

      // Update price calculation
      function updatePrice() {
        if (!packageSelect || !guestsInput || !accommodationSelect) return;

        const selectedPackage = packageSelect.value;
        const guests = parseInt(guestsInput.value) || 1;
        const accommodation = accommodationSelect.value;

        const basePriceEl = document.getElementById('base-price');
        const totalPriceEl = document.getElementById('total-price');
        const guestCountEl = document.getElementById('guest-count');
        const accFeeEl = document.getElementById('accommodation-fee');

        if (!selectedPackage || !packageData[selectedPackage]) {
          if (basePriceEl) basePriceEl.textContent = '$0';
          if (totalPriceEl) totalPriceEl.textContent = '$0';
          return;
        }

        const basePrice = packageData[selectedPackage].price;
        const accommodationFee = accommodation === 'single' ? 200 : 0;
        const total = basePrice * guests + accommodationFee * guests;

        if (basePriceEl) basePriceEl.textContent = `$${basePrice.toLocaleString()}`;
        if (guestCountEl) guestCountEl.textContent = guests.toString();
        if (accFeeEl) accFeeEl.textContent = `$${(accommodationFee * guests).toLocaleString()}`;
        if (totalPriceEl) totalPriceEl.textContent = `$${total.toLocaleString()}`;
      }

      // Update end date based on package duration
      function updateEndDate() {
        if (!packageSelect || !startDateInput || !endDateInput) return;

        const selectedPackage = packageSelect.value;
        const startDate = startDateInput.value;

        if (!selectedPackage || !startDate || !packageData[selectedPackage]) {
          endDateInput.value = '';
          return;
        }

        const duration = packageData[selectedPackage].duration;
        endDateInput.value = addDaysToDate(startDate, duration);
      }

      // Event listeners
      if (packageSelect) {
        packageSelect.addEventListener('change', () => {
          updatePrice();
          updateEndDate();
        });
      }

      if (startDateInput) startDateInput.addEventListener('change', updateEndDate);
      if (guestsInput) guestsInput.addEventListener('input', updatePrice);
      if (accommodationSelect) accommodationSelect.addEventListener('change', updatePrice);

      // Form submission
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!submitBtn || !statusDiv) return;

          // Show loading state
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>Processing...</span>';
          statusDiv.classList.add('hidden');

          try {
            // Collect form data
            const formData = new FormData(form);
            const totalPriceEl = document.getElementById('total-price');
            const totalPriceText = totalPriceEl ? totalPriceEl.textContent : '0';
            const totalPrice = parseFloat(totalPriceText.replace(/[^0-9.]/g, ''));

            const bookingData = {
              packageSlug: formData.get('package'),
              customerFirstName: formData.get('first-name'),
              customerLastName: formData.get('last-name'),
              customerEmail: formData.get('email'),
              customerPhone: formData.get('phone'),
              customerCountry: formData.get('country'),
              numberOfGuests: parseInt(formData.get('guests')),
              startDate: formData.get('start-date'),
              endDate: formData.get('end-date'),
              specialRequests: formData.get('special-requests'),
              totalPrice: totalPrice,
            };

            console.log('Submitting booking:', bookingData);

            // Send booking to API
            const response = await fetch('/api/bookings/create', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(bookingData),
            });

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.error || 'Failed to create booking');
            }

            // Redirect to confirmation with booking number
            window.location.href = `/book/confirmation?ref=${result.data.bookingNumber}`;
          } catch (error) {
            console.error('Booking error:', error);
            
            // Show error
            statusDiv.className = 'bg-red-100 text-red-800 rounded-lg p-4';
            statusDiv.innerHTML = `
              <p class="font-medium">Booking submission failed</p>
              <p class="text-sm mt-1">${error.message || 'Please try again or contact us directly.'}</p>
            `;
            statusDiv.classList.remove('hidden');

            // Reset button
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
              <span>Submit Booking Request</span>
              <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
              </svg>
            `;
          }
        });
      }

      // Initialize price on page load
      updatePrice();
      updateEndDate();
    });
  </script>
</Layout>
