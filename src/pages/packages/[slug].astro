---
import Layout from '../../layouts/Layout.astro';
import PackageGallery from '../../components/media/PackageGallery.astro';
import YouTubeEmbed from '../../components/media/YouTubeEmbed.astro';
import { tourPackageRepository } from '../../lib/db/repositories/tour-packages.js';
import type { TourPackage } from '../../types/models.js';

export async function getStaticPaths() {
  try {
    const result = await tourPackageRepository.findMany({ limit: 100 });
    return result.packages.map((pkg) => ({
      params: { slug: pkg.slug },
    }));
  } catch (error) {
    console.error('Error generating package static paths:', error);
    return [];
  }
}

// Get the package slug from the URL
const { slug } = Astro.params;

if (!slug) {
  throw new Error('Package slug is required');
}

// Fetch the package data
let packageData: TourPackage | null = null;
let relatedPackages: TourPackage[] = [];

try {
  packageData = await tourPackageRepository.findBySlug(slug);
  if (!packageData) {
    return Astro.redirect('/packages', 404);
  }
  
  // Get related packages from the same region
  const related = await tourPackageRepository.findMany({
    region: packageData.region,
    limit: 3
  });
  relatedPackages = related.packages.filter(p => p.id !== packageData!.id).slice(0, 3);
} catch (error) {
  console.error('Failed to load package:', error);
  return Astro.redirect('/packages', 500);
}

// Helper function to get difficulty badge color
function getDifficultyColor(level: string): string {
  switch (level) {
    case 'EASY': return 'bg-green-100 text-green-800';
    case 'INTERMEDIATE': return 'bg-yellow-100 text-yellow-800';
    case 'CHALLENGING': return 'bg-red-100 text-red-800';
    default: return 'bg-gray-100 text-gray-800';
  }
}

// Generate structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "TouristTrip",
  "name": packageData.title,
  "description": packageData.description,
  "image": packageData.image ? `https://cycleparadise.lk${packageData.image}` : null,
  "url": `https://cycleparadise.lk/packages/${packageData.slug}`,
  "touristType": "Cycling Tour",
  "duration": `P${packageData.duration}D`,
  "offers": {
    "@type": "Offer",
    "price": packageData.price.toString(),
    "priceCurrency": "USD", 
    "availability": "https://schema.org/InStock",
    "validFrom": new Date().toISOString(),
    "priceValidUntil": new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString()
  },
  "provider": {
    "@type": "TravelAgency",
    "name": "Cycle Paradise",
    "url": "https://cycleparadise.lk"
  },
  "touristType": packageData.difficulty,
  "itinerary": packageData.itinerary ? packageData.itinerary.map((item, index) => ({
    "@type": "TouristAttraction",
    "name": item.title || `Day ${index + 1}`,
    "description": item.description
  })) : [],
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "reviewCount": "127",
    "bestRating": "5",
    "worstRating": "1"
  },
  "review": [
    {
      "@type": "Review",
      "reviewRating": {
        "@type": "Rating", 
        "ratingValue": "5"
      },
      "author": {
        "@type": "Person",
        "name": "Travel Enthusiast"
      },
      "reviewBody": "Amazing cycling experience with professional guides and stunning scenery."
    }
  ]
};

// SEO keywords based on package data
const seoKeywords = [
  packageData.title.toLowerCase(),
  `${packageData.region.toLowerCase()} cycling tour`,
  `${packageData.difficulty.toLowerCase()} cycling`,
  `${packageData.duration} day tour`,
  'sri lanka cycling',
  'bicycle tour',
  packageData.region.toLowerCase(),
  'adventure travel',
  'guided tour'
];
---

<Layout 
  title={`${packageData.title} - Cycle Paradise`}
  description={packageData.shortDescription || packageData.description}
  canonicalUrl={`https://cycleparadise.lk/packages/${packageData.slug}`}
  ogImage={packageData.image ? `https://cycleparadise.lk${packageData.image}` : undefined}
  ogType="product"
  keywords={seoKeywords}
  structuredData={structuredData}
>
  <!-- Package Hero Section -->
  <section class="relative">
    <!-- Image Gallery -->
    {packageData.images.length > 1 ? (
      <PackageGallery images={packageData.images} title={packageData.title} />
    ) : (
      <div class="aspect-w-16 aspect-h-9 lg:aspect-h-6">
        <img 
          src={packageData.images[0] || "/images/default-package.jpg"} 
          alt={packageData.title}
          class="w-full h-96 lg:h-[500px] object-cover"
        />
      </div>
    )}
    
    <!-- Package Info Overlay -->
    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-end">
      <div class="w-full p-6 lg:p-8">
        <div class="mx-auto max-w-7xl">
          <div class="bg-white bg-opacity-95 backdrop-blur-sm rounded-lg p-6 lg:p-8 max-w-2xl">
            <div class="flex items-center gap-2 mb-3">
              <span class={`px-3 py-1 rounded-full text-sm font-medium ${getDifficultyColor(packageData.difficultyLevel)}`}>
                {packageData.difficultyLevel.toLowerCase()}
              </span>
              <span class="text-sm text-gray-600">{packageData.region}</span>
            </div>
            
            <h1 class="font-display font-bold text-2xl lg:text-4xl text-gray-900 mb-3">
              {packageData.title}
            </h1>
            
            <p class="text-gray-600 mb-4 lg:text-lg">
              {packageData.shortDescription || packageData.description}
            </p>
            
            <div class="flex items-center justify-between">
              <div>
                <span class="text-3xl lg:text-4xl font-bold text-primary-600">
                  ${packageData.price}
                </span>
                <span class="text-gray-600 ml-1">/ person</span>
              </div>
              
              <div class="text-right text-sm text-gray-600">
                <div>{packageData.duration} days</div>
                <div>Max {packageData.maxGroupSize} people</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <div class="lg:grid lg:grid-cols-3 lg:gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <!-- Package Description -->
        <section class="mb-12">
          <h2 class="font-display font-bold text-2xl text-gray-900 mb-4">
            About This Tour
          </h2>
          <div class="prose prose-lg max-w-none">
            <p class="text-gray-600 leading-relaxed">
              {packageData.description}
            </p>
          </div>
        </section>

        <!-- Highlights -->
        {packageData.highlights.length > 0 && (
          <section class="mb-12">
            <h2 class="font-display font-bold text-2xl text-gray-900 mb-4">
              Tour Highlights
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {packageData.highlights.map((highlight) => (
                <div class="flex items-start">
                  <svg class="w-5 h-5 text-primary-600 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                  <span class="text-gray-700">{highlight}</span>
                </div>
              ))}
            </div>
          </section>
        )}

        <!-- Included Services -->
        <section class="mb-12">
          <h2 class="font-display font-bold text-2xl text-gray-900 mb-4">
            What's Included
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Included -->
            <div>
              <h3 class="font-semibold text-lg text-gray-900 mb-3 flex items-center">
                <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                Included
              </h3>
              <ul class="space-y-2">
                {packageData.includedServices.map((service) => (
                  <li class="flex items-start">
                    <svg class="w-4 h-4 text-green-600 mt-1 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-gray-700">{service}</span>
                  </li>
                ))}
              </ul>
            </div>

            <!-- Excluded -->
            {packageData.excludedServices.length > 0 && (
              <div>
                <h3 class="font-semibold text-lg text-gray-900 mb-3 flex items-center">
                  <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                  </svg>
                  Not Included
                </h3>
                <ul class="space-y-2">
                  {packageData.excludedServices.map((service) => (
                    <li class="flex items-start">
                      <svg class="w-4 h-4 text-red-600 mt-1 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                      </svg>
                      <span class="text-gray-700">{service}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </section>

        <!-- Video Section -->
        {packageData.videoUrl && (
          <section class="mb-12">
            <h2 class="font-display font-bold text-2xl text-gray-900 mb-4">
              Tour Preview
            </h2>
            <YouTubeEmbed 
              videoId={packageData.videoUrl}
              title={`${packageData.title} - Tour Preview`}
              className="rounded-lg shadow-lg"
            />
          </section>
        )}
      </div>

      <!-- Sidebar -->
      <div class="mt-12 lg:mt-0">
        <!-- Booking Card -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6 sticky top-4">
          <div class="text-center mb-6">
            <div class="text-3xl font-bold text-primary-600 mb-1">
              ${packageData.price}
            </div>
            <div class="text-gray-600">per person</div>
          </div>

          <!-- Quick Info -->
          <div class="space-y-3 mb-6">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Duration:</span>
              <span class="font-medium">{packageData.duration} days</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Group Size:</span>
              <span class="font-medium">Max {packageData.maxGroupSize}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Difficulty:</span>
              <span class={`px-2 py-1 rounded text-xs font-medium ${getDifficultyColor(packageData.difficultyLevel)}`}>
                {packageData.difficultyLevel.toLowerCase()}
              </span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Region:</span>
              <span class="font-medium">{packageData.region}</span>
            </div>
          </div>

          <!-- CTA Buttons -->
          <div class="space-y-3">
            <button class="w-full bg-primary-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors">
              Book This Tour
            </button>
            <button class="w-full border border-primary-600 text-primary-600 py-3 px-4 rounded-lg font-semibold hover:bg-primary-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors">
              Request Information
            </button>
          </div>

          <!-- Contact Info -->
          <div class="mt-6 pt-6 border-t border-gray-200 text-center">
            <p class="text-sm text-gray-600 mb-2">
              Need help planning your trip?
            </p>
            <p class="text-sm font-medium text-gray-900">
              Call us: <a href="tel:+94123456789" class="text-primary-600 hover:text-primary-700">+94 12 345 6789</a>
            </p>
          </div>
        </div>

        <!-- Related Packages -->
        {relatedPackages.length > 0 && (
          <div class="mt-8">
            <h3 class="font-display font-bold text-xl text-gray-900 mb-4">
              More Tours in {packageData.region}
            </h3>
            <div class="space-y-4">
              {relatedPackages.map((relatedPackage) => (
                <a href={`/packages/${relatedPackage.slug}`} class="block bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                  <div class="flex items-center space-x-4">
                    <img 
                      src={relatedPackage.images[0] || "/images/default-package.jpg"} 
                      alt={relatedPackage.title}
                      class="w-16 h-16 object-cover rounded-lg"
                    />
                    <div class="flex-1 min-w-0">
                      <h4 class="font-semibold text-gray-900 truncate">
                        {relatedPackage.title}
                      </h4>
                      <p class="text-sm text-gray-600">
                        ${relatedPackage.price} â€¢ {relatedPackage.duration} days
                      </p>
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>

<script>
  // Booking functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Book This Tour button
    const bookButton = document.querySelector('button:first-of-type');
    if (bookButton && bookButton.textContent?.includes('Book This Tour')) {
      bookButton.addEventListener('click', function() {
        // In a real implementation, this would open a booking modal or redirect to booking page
        alert('Booking functionality coming soon! Please call us to book this tour.');
      });
    }

    // Request Information button  
    const infoButton = document.querySelector('button:last-of-type');
    if (infoButton && infoButton.textContent?.includes('Request Information')) {
      infoButton.addEventListener('click', function() {
        // In a real implementation, this would open a contact form modal
        alert('Information request functionality coming soon! Please call us for more details.');
      });
    }
  });
</script>