
---
import UserForm from '../../../components/admin/UserForm.astro';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { prisma } from '../../../lib/db/connection';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/admin/login');
}

// Fetch fresh data for the logged-in user
let userData = null;
try {
  userData = await prisma.adminUser.findUnique({
    where: { id: user.userId }, // Assuming user.userId from session matches DB id
    select: {
      id: true,
      email: true,
      firstName: true,
      lastName: true,
      role: true,
      isActive: true,
    }
  });
} catch (error) {
  console.error('Error fetching profile:', error);
}

// If user not found, something is wrong with session or DB
if (!userData) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Profile Settings" user={user}>
  <div class="max-w-3xl mx-auto">
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Profile Settings</h1>
      <p class="text-gray-600 mt-1">Manage your account and password</p>
    </div>

    <UserForm user={userData} isEdit={true} />
    
    <!-- Optional: Hide Role and Active Status for self-edit if needed, 
         but passing isEdit=true shows them. 
         Ideally, a user shouldn't be able to change their own Role or Active status unless they are a Super Admin.
         But for now, I'll leave it open as per "No access control needed" request, just simple implementation.
         Or I could add logic in UserForm to disable those fields if modifying self, 
         but I'll keep it simple.
    -->
  </div>
</AdminLayout>
