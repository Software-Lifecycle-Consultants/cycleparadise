---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { bookingRepository } from '../../../lib/db/repositories/bookings';
import SearchBar from '../../../components/admin/SearchBar.astro';
import Pagination from '../../../components/admin/Pagination.astro';
import type { BookingStatus, PaymentStatus } from '@prisma/client';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/admin/login');
}

// Get query parameters
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = parseInt(Astro.url.searchParams.get('limit') || '10');
const q = Astro.url.searchParams.get('q') || '';
const status = Astro.url.searchParams.get('status') as BookingStatus | '';
const paymentStatus = Astro.url.searchParams.get('paymentStatus') as PaymentStatus | '';
const packageId = Astro.url.searchParams.get('packageId') || '';
const startDate = Astro.url.searchParams.get('startDate') || '';
const endDate = Astro.url.searchParams.get('endDate') || '';

// Fetch bookings and packages for filter
let bookings: any[] = [];
let total = 0;
let stats = { pending: 0, confirmed: 0, cancelled: 0, completed: 0 };
let packages: any[] = [];
let error = '';

try {
  const [result, packageList] = await Promise.all([
    bookingRepository.findMany({
      query: q,
      status: status || undefined,
      paymentStatus: paymentStatus || undefined,
      packageId: packageId || undefined,
      startDate: startDate ? new Date(startDate) : undefined,
      endDate: endDate ? new Date(endDate) : undefined,
      page,
      limit
    }),
    bookingRepository.getPackages()
  ]);

  bookings = result.bookings;
  total = result.total;
  stats = result.stats;
  packages = packageList;
} catch (err) {
  console.error('Failed to load bookings:', err);
  error = 'Failed to load bookings';
}

const totalPages = Math.ceil(total / limit);

// Helper functions
const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
};

const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0
  }).format(amount);
};

const getStatusColor = (status: string) => {
  const colors: Record<string, string> = {
    PENDING: 'bg-yellow-100 text-yellow-800',
    CONFIRMED: 'bg-green-100 text-green-800',
    CANCELLED: 'bg-red-100 text-red-800',
    COMPLETED: 'bg-blue-100 text-blue-800'
  };
  return colors[status] || 'bg-gray-100 text-gray-800';
};

const getPaymentColor = (status: string) => {
  const colors: Record<string, string> = {
    PENDING: 'bg-orange-100 text-orange-800',
    PAID: 'bg-green-100 text-green-800',
    PARTIAL: 'bg-yellow-100 text-yellow-800',
    REFUNDED: 'bg-gray-100 text-gray-800'
  };
  return colors[status] || 'bg-gray-100 text-gray-800';
};

const calculateDuration = (startDate: Date, endDate: Date) => {
  const start = new Date(startDate);
  const end = new Date(endDate);
  const diffTime = Math.abs(end.getTime() - start.getTime());
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
};

// Build export URL with current filters
const exportParams = new URLSearchParams();
if (q) exportParams.set('q', q);
if (status) exportParams.set('status', status);
if (paymentStatus) exportParams.set('paymentStatus', paymentStatus);
if (packageId) exportParams.set('packageId', packageId);
if (startDate) exportParams.set('startDate', startDate);
if (endDate) exportParams.set('endDate', endDate);
const exportUrl = `/api/admin/bookings/export${exportParams.toString() ? '?' + exportParams.toString() : ''}`;
---

<AdminLayout title="Bookings" user={user}>
  <!-- Header with Stats -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Bookings</h1>
        <p class="text-gray-600 mt-1">Manage tour bookings and reservations</p>
      </div>
      <a
        href={exportUrl}
        class="inline-flex items-center px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium"
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Export CSV
      </a>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <div class="text-sm text-gray-600">Pending</div>
        <div class="text-2xl font-bold text-yellow-600">{stats.pending}</div>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <div class="text-sm text-gray-600">Confirmed</div>
        <div class="text-2xl font-bold text-green-600">{stats.confirmed}</div>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <div class="text-sm text-gray-600">Completed</div>
        <div class="text-2xl font-bold text-blue-600">{stats.completed}</div>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <div class="text-sm text-gray-600">Cancelled</div>
        <div class="text-2xl font-bold text-red-600">{stats.cancelled}</div>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
    <div class="space-y-4">
      <!-- Search Bar -->
      <div class="flex-1">
        <SearchBar
          action="/admin/bookings"
          query={q}
          placeholder="Search by booking number, customer name, or email..."
        />
      </div>

      <!-- Filter Row -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <!-- Status Filter -->
        <select
          name="status"
          class="filter-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md"
        >
          <option value="">All Status</option>
          <option value="PENDING" selected={status === 'PENDING'}>Pending</option>
          <option value="CONFIRMED" selected={status === 'CONFIRMED'}>Confirmed</option>
          <option value="CANCELLED" selected={status === 'CANCELLED'}>Cancelled</option>
          <option value="COMPLETED" selected={status === 'COMPLETED'}>Completed</option>
        </select>

        <!-- Payment Status Filter -->
        <select
          name="paymentStatus"
          class="filter-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md"
        >
          <option value="">All Payment Status</option>
          <option value="PENDING" selected={paymentStatus === 'PENDING'}>Pending</option>
          <option value="PAID" selected={paymentStatus === 'PAID'}>Paid</option>
          <option value="PARTIAL" selected={paymentStatus === 'PARTIAL'}>Partial</option>
          <option value="REFUNDED" selected={paymentStatus === 'REFUNDED'}>Refunded</option>
        </select>

        <!-- Package Filter -->
        <select
          name="packageId"
          class="filter-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md"
        >
          <option value="">All Packages</option>
          {packages.map((pkg) => (
            <option value={pkg.id} selected={packageId === pkg.id}>
              {pkg.title}
            </option>
          ))}
        </select>

        <!-- Start Date Filter -->
        <input
          type="date"
          name="startDate"
          value={startDate}
          class="filter-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md"
          placeholder="Start Date"
        />

        <!-- End Date Filter -->
        <input
          type="date"
          name="endDate"
          value={endDate}
          class="filter-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md"
          placeholder="End Date"
        />
      </div>
    </div>
  </div>

  {error && (
    <div class="mb-6 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
      {error}
    </div>
  )}

  <!-- Bookings Table -->
  <div id="booking-list-view">
    {bookings.length === 0 ? (
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
        <svg class="mx-auto w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No bookings found</h3>
        <p class="text-gray-600">No bookings match your current filters.</p>
      </div>
    ) : (
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Booking #
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Customer
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Package
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Tour Dates
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Participants
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Amount
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Status
                </th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {bookings.map((booking) => (
                <tr class="hover:bg-gray-50 transition">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">{booking.bookingNumber}</div>
                    <div class="text-xs text-gray-500">
                      {formatDate(booking.submittedAt)}
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900">{booking.customerName}</div>
                    <div class="text-sm text-gray-500">{booking.customerEmail}</div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 max-w-xs truncate">
                      {booking.package.title}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">{formatDate(booking.startDate)}</div>
                    <div class="text-xs text-gray-500">
                      {calculateDuration(booking.startDate, booking.endDate)} days
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-900">{booking.numberOfParticipants}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">
                      {formatCurrency(booking.totalAmount)}
                    </div>
                    <div class="mt-1">
                      <span class={`inline-flex px-2 py-0.5 text-xs font-semibold rounded-full ${getPaymentColor(booking.paymentStatus)}`}>
                        {booking.paymentStatus}
                      </span>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(booking.status)}`}>
                      {booking.status}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a
                      href={`/admin/bookings/${booking.id}`}
                      class="text-emerald-600 hover:text-emerald-900"
                    >
                      View Details
                    </a>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <Pagination
          currentPage={page}
          totalPages={totalPages}
          baseUrl="/admin/bookings"
          searchParams={Astro.url.searchParams}
        />
      </div>
    )}
  </div>

  <script>
    // Real-time Search and Filtering
    const searchInput = document.querySelector('input[name="q"]') as HTMLInputElement;
    const filterSelects = document.querySelectorAll('.filter-select');
    const listContainer = document.getElementById('booking-list-view');

    let debounceTimer: any;

    function getCurrentParams() {
      const params = new URLSearchParams(window.location.search);

      if (searchInput) {
        if (searchInput.value) params.set('q', searchInput.value);
        else params.delete('q');
      }

      filterSelects.forEach((select: any) => {
        if (select.value) params.set(select.name, select.value);
        else params.delete(select.name);
      });

      params.set('page', '1');
      return params;
    }

    async function updateResults(params: URLSearchParams) {
      const url = `${window.location.pathname}?${params.toString()}`;

      try {
        window.history.pushState({}, '', url);
        const response = await fetch(url);
        const html = await response.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newContent = doc.getElementById('booking-list-view');

        if (newContent && listContainer) {
          listContainer.innerHTML = newContent.innerHTML;
        } else {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to update results:', error);
      }
    }

    // Attach listeners
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const params = getCurrentParams();
          updateResults(params);
        }, 300);
      });
    }

    filterSelects.forEach((select) => {
      select.addEventListener('change', () => {
        const params = getCurrentParams();
        updateResults(params);
      });
    });

    // Handle Pagination Clicks
    if (listContainer) {
      listContainer.addEventListener('click', (e: any) => {
        const link = e.target.closest('a');
        if (link && link.closest('.pagination-container')) {
          e.preventDefault();
          const url = new URL(link.href);
          const params = url.searchParams;
          updateResults(params);
        }
      });
    }
  </script>
</AdminLayout>
