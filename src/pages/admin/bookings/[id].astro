---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { bookingRepository } from '../../../lib/db/repositories/bookings';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/admin/login');
}

const bookingId = Astro.params.id;

let booking: any = null;
let error = '';

if (bookingId) {
  try {
    booking = await bookingRepository.findById(bookingId);
    if (!booking) {
      error = 'Booking not found';
    }
  } catch (err) {
    console.error('Failed to load booking:', err);
    error = 'Failed to load booking';
  }
}

// Helper functions
const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const formatDateTime = (date: Date) => {
  return new Date(date).toLocaleString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2
  }).format(amount);
};

const getStatusColor = (status: string) => {
  const colors: Record<string, string> = {
    PENDING: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    CONFIRMED: 'bg-green-100 text-green-800 border-green-200',
    CANCELLED: 'bg-red-100 text-red-800 border-red-200',
    COMPLETED: 'bg-blue-100 text-blue-800 border-blue-200'
  };
  return colors[status] || 'bg-gray-100 text-gray-800 border-gray-200';
};

const getPaymentColor = (status: string) => {
  const colors: Record<string, string> = {
    PENDING: 'bg-orange-100 text-orange-800 border-orange-200',
    PAID: 'bg-green-100 text-green-800 border-green-200',
    PARTIAL: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    REFUNDED: 'bg-gray-100 text-gray-800 border-gray-200'
  };
  return colors[status] || 'bg-gray-100 text-gray-800 border-gray-200';
};

const calculateDuration = (startDate: Date, endDate: Date) => {
  const start = new Date(startDate);
  const end = new Date(endDate);
  const diffTime = Math.abs(end.getTime() - start.getTime());
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
};
---

<AdminLayout title={booking ? `Booking ${booking.bookingNumber}` : 'Booking Details'} user={user}>
  <!-- Breadcrumb and Header -->
  <div class="mb-6">
    <div class="flex items-center space-x-2 text-sm text-gray-600 mb-2">
      <a href="/admin/bookings" class="hover:text-emerald-600">Bookings</a>
      <span>/</span>
      <span class="text-gray-900">{booking?.bookingNumber || 'Details'}</span>
    </div>

    {booking && (
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Booking {booking.bookingNumber}</h1>
          <p class="text-gray-600 mt-1">Submitted {formatDateTime(booking.submittedAt)}</p>
        </div>
        <div class="flex items-center space-x-3">
          <span class={`inline-flex px-3 py-1.5 text-sm font-semibold rounded-lg border ${getStatusColor(booking.status)}`}>
            {booking.status}
          </span>
          <span class={`inline-flex px-3 py-1.5 text-sm font-semibold rounded-lg border ${getPaymentColor(booking.paymentStatus)}`}>
            Payment: {booking.paymentStatus}
          </span>
          <button
            onclick="openEmailModal()"
            class="inline-flex items-center px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            Email Customer
          </button>
        </div>
      </div>
    )}
  </div>

  {error && (
    <div class="mb-6 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
      {error}
    </div>
  )}

  {booking && (
    <div id="booking-details-container" data-booking-id={booking.id} class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content (Left) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Customer Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Customer Information</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium text-gray-500">Name</label>
              <p class="text-gray-900 mt-1">{booking.customerName}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Email</label>
              <p class="text-gray-900 mt-1">
                <a href={`mailto:${booking.customerEmail}`} class="text-emerald-600 hover:underline">
                  {booking.customerEmail}
                </a>
              </p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Phone</label>
              <p class="text-gray-900 mt-1">
                <a href={`tel:${booking.customerPhone}`} class="text-emerald-600 hover:underline">
                  {booking.customerPhone}
                </a>
              </p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Country</label>
              <p class="text-gray-900 mt-1">{booking.customerCountry || 'Not specified'}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Number of Participants</label>
              <p class="text-gray-900 mt-1">{booking.numberOfParticipants}</p>
            </div>
          </div>

          {booking.specialRequests && (
            <div class="mt-4 pt-4 border-t border-gray-200">
              <label class="text-sm font-medium text-gray-500">Special Requests</label>
              <p class="text-gray-900 mt-1 whitespace-pre-wrap">{booking.specialRequests}</p>
            </div>
          )}
        </div>

        <!-- Tour Details -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Tour Details</h2>

          <div class="mb-4">
            <label class="text-sm font-medium text-gray-500">Package</label>
            <p class="text-gray-900 mt-1">
              <a href={`/admin/packages/${booking.package.id}`} class="text-emerald-600 hover:underline font-medium">
                {booking.package.title}
              </a>
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="text-sm font-medium text-gray-500">Start Date</label>
              <p class="text-gray-900 mt-1">{formatDate(booking.startDate)}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">End Date</label>
              <p class="text-gray-900 mt-1">{formatDate(booking.endDate)}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Duration</label>
              <p class="text-gray-900 mt-1">
                {calculateDuration(booking.startDate, booking.endDate)} days
              </p>
            </div>
          </div>

          <!-- Pricing Breakdown -->
          <div class="pt-4 border-t border-gray-200">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Pricing Breakdown</h3>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Base Price (per person)</span>
                <span class="text-gray-900">{formatCurrency(booking.package.basePrice)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Participants</span>
                <span class="text-gray-900">{booking.numberOfParticipants}</span>
              </div>
              {booking.bookingAccommodations && booking.bookingAccommodations.length > 0 && (
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Accommodations</span>
                  <span class="text-gray-900">
                    {formatCurrency(
                      booking.bookingAccommodations.reduce((sum: number, ba: any) =>
                        sum + Number(ba.totalAccommodationCost), 0
                      )
                    )}
                  </span>
                </div>
              )}
              <div class="flex justify-between text-base font-semibold pt-2 border-t border-gray-200">
                <span class="text-gray-900">Total Amount</span>
                <span class="text-emerald-600">{formatCurrency(booking.totalAmount)}</span>
              </div>
            </div>
          </div>

          {booking.confirmationNotes && (
            <div class="mt-4 pt-4 border-t border-gray-200">
              <label class="text-sm font-medium text-gray-500">Confirmation Notes</label>
              <p class="text-gray-900 mt-1 whitespace-pre-wrap">{booking.confirmationNotes}</p>
            </div>
          )}
        </div>

        <!-- Status History -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Status History</h2>

          {booking.statusHistory && booking.statusHistory.length > 0 ? (
            <div class="space-y-4">
              {booking.statusHistory.map((history: any) => (
                <div class="flex gap-4 pb-4 border-b border-gray-200 last:border-0">
                  <div class="flex-shrink-0 w-2 h-2 mt-2 rounded-full bg-emerald-500"></div>
                  <div class="flex-1">
                    <div class="flex items-start justify-between">
                      <div>
                        {history.newStatus && (
                          <p class="text-sm font-medium text-gray-900">
                            Status changed from {history.previousStatus || 'N/A'} to {history.newStatus}
                          </p>
                        )}
                        {history.newPayment && (
                          <p class="text-sm font-medium text-gray-900">
                            Payment status changed from {history.previousPayment || 'N/A'} to {history.newPayment}
                          </p>
                        )}
                        {history.notes && (
                          <p class="text-sm text-gray-600 mt-1">{history.notes}</p>
                        )}
                        <p class="text-xs text-gray-500 mt-1">
                          By {history.admin.firstName} {history.admin.lastName}
                        </p>
                      </div>
                      <span class="text-xs text-gray-500 whitespace-nowrap">
                        {formatDateTime(history.createdAt)}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p class="text-gray-500 text-sm">No status changes yet</p>
          )}
        </div>
      </div>

      <!-- Sidebar (Right) -->
      <div class="space-y-6">
        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
          <div class="space-y-3">
            <button
              id="updateStatusBtn"
              type="button"
              class="w-full px-4 py-2 bg-indigo-100 text-indigo-600 rounded-lg hover:bg-indigo-300 transition font-medium flex items-center justify-center"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Update Status
            </button>
            <button
              id="sendEmailBtn"
              type="button"
              class="w-full px-4 py-2 bg-violet-100 text-violet-600 rounded-lg hover:bg-violet-300 transition font-medium flex items-center justify-center"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
              Send Email
            </button>
            <button
              id="updatePaymentBtn"
              type="button"
              class="w-full px-4 py-2 bg-emerald-100 text-emerald-600 rounded-lg hover:bg-emerald-300 transition font-medium flex items-center justify-center"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Update Payment
            </button>
            <button
              id="deleteBookingBtn"
              type="button"
              data-booking-id={booking.id}
              data-booking-number={booking.bookingNumber}
              class="w-full px-4 py-2 bg-rose-400 text-white rounded-lg hover:bg-rose-500 border transition font-medium flex items-center justify-center"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              Delete Booking
            </button>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Information</h2>
          <div class="space-y-3">
            <div>
              <label class="text-sm font-medium text-gray-500">Method</label>
              <p class="text-gray-900 mt-1">{booking.paymentMethod}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Status</label>
              <p class="mt-1">
                <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPaymentColor(booking.paymentStatus)}`}>
                  {booking.paymentStatus}
                </span>
              </p>
            </div>
            {booking.confirmedAt && (
              <div>
                <label class="text-sm font-medium text-gray-500">Confirmed At</label>
                <p class="text-gray-900 mt-1 text-sm">{formatDateTime(booking.confirmedAt)}</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  )}

  <!-- Update Status Modal -->
  <div id="statusModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Update Booking Status</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Current Status</label>
          <p class="text-gray-900">{booking?.status}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            New Status <span class="text-red-500">*</span>
          </label>
          <select
            id="newStatus"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
          >
            <option value="">Select status...</option>
            <option value="PENDING">Pending</option>
            <option value="CONFIRMED">Confirmed</option>
            <option value="CANCELLED">Cancelled</option>
            <option value="COMPLETED">Completed</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
          <textarea
            id="statusNotes"
            rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
            placeholder="Add notes about this status change..."
          ></textarea>
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button
          onclick="closeStatusModal()"
          class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
        >
          Cancel
        </button>
        <button
          id="saveStatusBtn"
          class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"
        >
          Update Status
        </button>
      </div>
    </div>
  </div>

  <!-- Update Payment Modal -->
  <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Update Payment Status</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Current Payment Status</label>
          <p class="text-gray-900">{booking?.paymentStatus}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            New Payment Status <span class="text-red-500">*</span>
          </label>
          <select
            id="newPaymentStatus"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
          >
            <option value="">Select payment status...</option>
            <option value="PENDING">Pending</option>
            <option value="PAID">Paid</option>
            <option value="PARTIAL">Partial</option>
            <option value="REFUNDED">Refunded</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
          <textarea
            id="paymentNotes"
            rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
            placeholder="Add notes about this payment..."
          ></textarea>
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button
          onclick="closePaymentModal()"
          class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
        >
          Cancel
        </button>
        <button
          id="savePaymentBtn"
          class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium"
        >
          Update Payment
        </button>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="emailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Send Email to Customer</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Template</label>
          <select
            id="emailTemplate"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
          >
            <option value="confirmation">Booking Confirmation</option>
            <option value="cancellation">Cancellation Notice</option>
            <option value="custom">Custom Message</option>
          </select>
        </div>

        <div id="customEmailSection" class="hidden">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
            <input
              type="text"
              id="emailSubject"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
              placeholder="Email subject..."
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
            <textarea
              id="emailMessage"
              rows="6"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
              placeholder="Email message..."
            ></textarea>
          </div>
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button
          onclick="closeEmailModal()"
          class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
        >
          Cancel
        </button>
        <button
          id="sendEmailBtnModal"
          class="flex-1 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition font-medium"
        >
          Send Email
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
      <div class="flex items-center justify-center w-12 h-12 bg-rose-100 rounded-full mx-auto mb-4">
        <svg class="w-6 h-6 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Delete Booking</h3>
      <p class="text-gray-600 text-center mb-4">
        Are you sure you want to delete booking <strong id="bookingNumber" class="text-gray-900"></strong>?
      </p>
      <div class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-6">
        <p class="text-sm text-rose-800 font-medium">Warning: This action cannot be undone</p>
        <p class="text-xs text-rose-600 mt-1">All booking data, history, and related records will be permanently deleted.</p>
      </div>
      <div class="flex space-x-3">
        <button
          onclick="closeDeleteModal()"
          class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
        >
          Cancel
        </button>
        <button
          id="confirmDeleteBtn"
          class="flex-1 px-4 py-2 bg-rose-200 text-white rounded-lg hover:bg-rose-300 transition font-medium"
        >
          Delete Permanently
        </button>
      </div>
    </div>
  </div>

  <script define:vars={{ bookingId: booking?.id }}>
    // Import utilities (available globally from AdminLayout)
    // We access them directly from window to avoid race conditions
    // bookingId is available via define:vars

    // Modal Management
    function openStatusModal() {
      document.getElementById('statusModal')?.classList.remove('hidden');
    }

    function closeStatusModal() {
      document.getElementById('statusModal')?.classList.add('hidden');
      const newStatus = document.getElementById('newStatus');
      if (newStatus) newStatus.value = '';
      const statusNotes = document.getElementById('statusNotes');
      if (statusNotes) statusNotes.value = '';
    }

    function openPaymentModal() {
      document.getElementById('paymentModal')?.classList.remove('hidden');
    }

    function closePaymentModal() {
      document.getElementById('paymentModal')?.classList.add('hidden');
      const newPaymentStatus = document.getElementById('newPaymentStatus');
      if (newPaymentStatus) newPaymentStatus.value = '';
      const paymentNotes = document.getElementById('paymentNotes');
      if (paymentNotes) paymentNotes.value = '';
    }

    function openEmailModal() {
      document.getElementById('emailModal')?.classList.remove('hidden');
    }

    function closeEmailModal() {
      document.getElementById('emailModal')?.classList.add('hidden');
      const emailTemplate = document.getElementById('emailTemplate');
      if (emailTemplate) emailTemplate.value = 'confirmation';
      document.getElementById('customEmailSection')?.classList.add('hidden');
    }

    let bookingToDelete = '';

    function confirmDelete(id, number) {
      bookingToDelete = id;
      const modal = document.getElementById('deleteModal');
      const bookingNumberEl = document.getElementById('bookingNumber');
      if (bookingNumberEl) bookingNumberEl.textContent = number;
      modal?.classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal')?.classList.add('hidden');
      bookingToDelete = '';
    }

    // Make functions globally available
    window.openStatusModal = openStatusModal;
    window.closeStatusModal = closeStatusModal;
    window.openPaymentModal = openPaymentModal;
    window.closePaymentModal = closePaymentModal;
    window.openEmailModal = openEmailModal;
    window.closeEmailModal = closeEmailModal;
    window.closeDeleteModal = closeDeleteModal;

    // Attach event listeners to quick action buttons
    document.getElementById('updateStatusBtn')?.addEventListener('click', openStatusModal);
    document.getElementById('updatePaymentBtn')?.addEventListener('click', openPaymentModal);
    document.getElementById('sendEmailBtn')?.addEventListener('click', openEmailModal);

    const deleteBtn = document.getElementById('deleteBookingBtn');
    deleteBtn?.addEventListener('click', () => {
      const bookingId = deleteBtn.getAttribute('data-booking-id') || '';
      const bookingNumber = deleteBtn.getAttribute('data-booking-number') || '';
      confirmDelete(bookingId, bookingNumber);
    });

    // Email template change
    document.getElementById('emailTemplate')?.addEventListener('change', (e) => {
      const customSection = document.getElementById('customEmailSection');
      if (e.target.value === 'custom') {
        customSection?.classList.remove('hidden');
      } else {
        customSection?.classList.add('hidden');
      }
    });

    // Update Status Handler
    document.getElementById('saveStatusBtn')?.addEventListener('click', async () => {
      const button = document.getElementById('saveStatusBtn');
      const newStatus = document.getElementById('newStatus').value;
      const notes = document.getElementById('statusNotes').value;

      // Validation
      if (!newStatus) {
        window.toastManager?.warning('Please select a status');
        return;
      }

      // Set loading state
      window.buttonLoader?.setLoading(button, 'Updating...');

      try {
        const result = await window.apiClient?.post(`/api/admin/bookings/${bookingId}/status`, {
          status: newStatus,
          notes
        });

        if (result?.success) {
          window.toastManager?.success('Status updated successfully');
          // Wait a moment for user to see the toast, then reload
          setTimeout(() => {
            window.location.reload();
          }, 800);
        } else {
          window.buttonLoader?.reset(button);
          window.toastManager?.error(result?.error || 'Failed to update status');
        }
      } catch (error) {
        window.buttonLoader?.reset(button);
        console.error('Status update error:', error);
        window.toastManager?.error('An unexpected error occurred');
      }
    });

    // Update Payment Handler
    document.getElementById('savePaymentBtn')?.addEventListener('click', async () => {
      const button = document.getElementById('savePaymentBtn');
      const newPaymentStatus = document.getElementById('newPaymentStatus').value;
      const notes = document.getElementById('paymentNotes').value;

      // Validation
      if (!newPaymentStatus) {
        window.toastManager?.warning('Please select a payment status');
        return;
      }

      // Set loading state
      window.buttonLoader?.setLoading(button, 'Updating...');

      try {
        const result = await window.apiClient?.post(`/api/admin/bookings/${bookingId}/payment`, {
          paymentStatus: newPaymentStatus,
          notes
        });

        if (result?.success) {
          window.toastManager?.success('Payment status updated successfully');
          setTimeout(() => {
            window.location.reload();
          }, 800);
        } else {
          window.buttonLoader?.reset(button);
          window.toastManager?.error(result?.error || 'Failed to update payment status');
        }
      } catch (error) {
        window.buttonLoader?.reset(button);
        console.error('Payment update error:', error);
        window.toastManager?.error('An unexpected error occurred');
      }
    });

    // Send Email Handler
    document.getElementById('sendEmailBtnModal')?.addEventListener('click', async () => {
      const button = document.getElementById('sendEmailBtnModal');
      const template = document.getElementById('emailTemplate').value;
      const subject = document.getElementById('emailSubject')?.value;
      const message = document.getElementById('emailMessage')?.value;

      const body = { template };
      if (template === 'custom') {
        if (!subject || !message) {
          window.toastManager?.warning('Please provide both subject and message for custom email');
          return;
        }
        body.subject = subject;
        body.message = message;
      }

      // Set loading state
      window.buttonLoader?.setLoading(button, 'Sending...');

      try {
        const result = await window.apiClient?.post(`/api/admin/bookings/${bookingId}/email`, body);

        if (result?.success) {
          window.toastManager?.success('Email sent successfully');
          window.buttonLoader?.reset(button);
          closeEmailModal();
        } else {
          window.buttonLoader?.reset(button);
          // Show error but don't close modal so user can retry
          window.toastManager?.error(result?.error || 'Failed to send email');
        }
      } catch (error) {
        window.buttonLoader?.reset(button);
        console.error('Email send error:', error);
        window.toastManager?.error('Failed to send email. Please try again.');
      }
    });

    // Delete Handler
    document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
      const button = document.getElementById('confirmDeleteBtn');
      if (!bookingToDelete) return;

      // Set loading state
      window.buttonLoader?.setLoading(button, 'Deleting...');

      try {
        const result = await window.apiClient?.delete(`/api/admin/bookings/${bookingToDelete}`);

        if (result?.success) {
          window.toastManager?.success('Booking deleted successfully. Redirecting...');
          setTimeout(() => {
            window.location.href = '/admin/bookings';
          }, 1000);
        } else {
          window.buttonLoader?.reset(button);
          window.toastManager?.error(result?.error || 'Failed to delete booking');
        }
      } catch (error) {
        window.buttonLoader?.reset(button);
        console.error('Delete error:', error);
        window.toastManager?.error('Failed to delete booking. Please try again.');
      }
    });
  </script>
</AdminLayout>
