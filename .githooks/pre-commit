#!/bin/bash

# Pre-commit hook to prevent common errors
set -e

echo "ğŸ” Running pre-commit checks..."

# 1. TypeScript type checking
echo "ğŸ“ Checking TypeScript..."
npx tsc --noEmit --skipLibCheck
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found. Please fix before committing."
  exit 1
fi

# 2. ESLint checks
echo "ğŸ”§ Running ESLint..."
npx eslint . --ext .ts,.js,.astro --max-warnings 0
if [ $? -ne 0 ]; then
  echo "âŒ ESLint errors found. Please fix before committing."
  exit 1
fi

# 3. Check for reserved word usage
echo "ğŸš« Checking for reserved word usage..."
if grep -r "\.map((package)" src/ --include="*.astro" --include="*.ts" --include="*.js"; then
  echo "âŒ Found usage of 'package' as variable name (reserved word). Use 'tourPackage', 'pkg', or similar instead."
  exit 1
fi

# 4. Check for common syntax errors
echo "ğŸ” Checking for common syntax errors..."
if grep -r "]);" src/ --include="*.ts" --include="*.js" | grep -v "async" | grep -v "Promise.all"; then
  echo "âš ï¸  Found potential extra ']); patterns. Please review."
fi

# 5. Check Astro build
echo "ğŸ—ï¸  Testing Astro build..."
npm run build > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "âŒ Astro build failed. Please fix build errors before committing."
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
exit 0