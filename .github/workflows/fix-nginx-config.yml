name: Fix Nginx Configuration

on:
  workflow_dispatch:

jobs:
  fix-nginx:
    runs-on: ubuntu-latest
    steps:
      - name: Fix Nginx configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            
            echo "=== Creating backup of current config ==="
            sudo cp /etc/nginx/sites-available/cycleparadise /etc/nginx/sites-available/cycleparadise.backup.$(date +%Y%m%d_%H%M%S)
            
            echo "=== Creating correct Nginx configuration ==="
            sudo tee /etc/nginx/sites-available/cycleparadise > /dev/null <<'EOF'
            # Rate limiting
            limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
            limit_req_zone $binary_remote_addr zone=general_limit:10m rate=30r/s;
            
            # Upstream backend
            upstream cycleparadise_backend {
                server 127.0.0.1:4321;
                keepalive 64;
            }
            
            # HTTP -> HTTPS redirect
            server {
                listen 80;
                listen [::]:80;
                server_name cycleparadise.bike www.cycleparadise.bike;
                
                # Allow Let's Encrypt challenges
                location /.well-known/acme-challenge/ {
                    root /var/www/html;
                }
                
                # Redirect all other HTTP traffic to HTTPS
                location / {
                    return 301 https://$host$request_uri;
                }
            }
            
            # HTTPS server
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name cycleparadise.bike www.cycleparadise.bike;
                
                # SSL configuration
                ssl_certificate /etc/letsencrypt/live/cycleparadise.bike/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/cycleparadise.bike/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
                
                # Security headers
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
                
                # Client body size limit
                client_max_body_size 10M;
                
                # Proxy to Node.js application
                location / {
                    proxy_pass http://cycleparadise_backend;
                    proxy_http_version 1.1;
                    
                    # Headers
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_set_header X-Forwarded-Host $host;
                    proxy_set_header X-Forwarded-Port $server_port;
                    
                    # WebSocket support (if needed)
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    
                    # Timeouts
                    proxy_connect_timeout 60s;
                    proxy_send_timeout 60s;
                    proxy_read_timeout 60s;
                    
                    # Buffering
                    proxy_buffering on;
                    proxy_buffer_size 4k;
                    proxy_buffers 8 4k;
                    proxy_busy_buffers_size 8k;
                }
                
                # Health check endpoint (optional - allow direct access)
                location /health {
                    proxy_pass http://cycleparadise_backend;
                    access_log off;
                }
                
                # Static files caching
                location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                    proxy_pass http://cycleparadise_backend;
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }
            EOF
            
            echo "=== Testing Nginx configuration ==="
            sudo nginx -t
            
            echo "=== Reloading Nginx ==="
            sudo systemctl reload nginx
            
            echo "=== Nginx status ==="
            sudo systemctl status nginx --no-pager
            
            echo "=== Testing local connection ==="
            sleep 2
            curl -I http://localhost:4321 || echo "Local connection failed"
            
            echo "=== Testing HTTPS connection ==="
            curl -I https://cycleparadise.bike || echo "HTTPS connection failed"
            
            echo "âœ… Nginx configuration fixed and reloaded!"
